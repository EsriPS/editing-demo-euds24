import{i as k}from"./CIMResourceManager-BDA76FPV.js";import{e as _,s as E,$ as F}from"./CIMSymbolHelper-CkjLOfcU.js";import{y as G}from"./OverrideHelper-D-UVQ00R.js";import{V as P}from"./utils-D7agaEG-.js";import"./fontUtils-BVEStqBT.js";import"./index-C1aGfQcb.js";import"./imageUtils-DpI9AOR9.js";import"./BidiEngine-DNnuvc1i.js";import"./OptimizedGeometry-C9mSZhHi.js";import"./GeometryUtils-Bkk2TwKC.js";import"./enums-CmIX1y88.js";import"./definitions-C0Jy3zs7.js";import"./mat2df32-BR-p9z6z.js";import"./vec2-D9okOEat.js";import"./vec2f32-BbH2jxlN.js";import"./Rect-CUzevAry.js";import"./BoundingBox-CnpCxTZE.js";import"./defaults-Dbnhuv3C.js";import"./defaultsJSON-GKolV7NZ.js";import"./colorUtils-BWiljOUv.js";import"./vec42-BHDxGccW.js";import"./vec4f64-o2zAXfmz.js";import"./quantizationUtils-DbJV_fl5.js";const $=96/72;class ot{constructor(y){this._spatialReference=y,this._imageDataCanvas=null,this._cimResourceManager=new k}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(y,d,w,f,o,r,s,n,M){if(!y)return null;const{data:m}=y;if(!m||m.type!=="CIMSymbolReference"||!m.symbol)return null;const{symbol:C}=m;r||(r=P(C));const a=await G.resolveSymbolOverrides(m,d,this._spatialReference,o,r,s,n),c=this._cimResourceManager,u=[];_.fetchResources(a,c,u),_.fetchFonts(a,c,u),u.length>0&&await Promise.all(u);const{width:e,height:i}=w,R=D(r,e,i,f),t=_.getEnvelope(a,R,c);if(!t)return null;t.x===1/0&&(t.x=e+2),t.y===1/0&&(t.y=-i/2),t.width===-1/0&&(t.width=e),t.height===-1/0&&(t.height=i);let h=1,v=0,x=0;switch(C.type){case"CIMPointSymbol":case"CIMTextSymbol":{let l=1;t.width>e&&(l=e/t.width);let g=1;t.height>i&&(g=i/t.height),f==="preview"&&(t.width<e&&(l=e/t.width),t.height<i&&(g=i/t.height)),h=Math.min(l,g),v=t.x+t.width/2,x=t.y+t.height/2}break;case"CIMLineSymbol":{(M||t.height>i)&&(h=i/t.height),x=t.y+t.height/2;const l=t.x*h+e/2,g=(t.x+t.width)*h+e/2,{paths:b}=R;b[0][0][0]-=l/h,b[0][2][0]-=(g-e)/h}break;case"CIMPolygonSymbol":{v=t.x+t.width/2,x=t.y+t.height/2;const l=t.x*h+e/2,g=(t.x+t.width)*h+e/2,b=t.y*h+i/2,I=(t.y+t.height)*h+i/2,{rings:p}=R;l<0&&(p[0][0][0]-=l,p[0][3][0]-=l,p[0][4][0]-=l),b<0&&(p[0][0][1]+=b,p[0][1][1]+=b,p[0][4][1]+=b),g>e&&(p[0][1][0]-=g-e,p[0][2][0]-=g-e),I>i&&(p[0][2][1]+=I-i,p[0][3][1]+=I-i)}}const z={type:"cim",data:{type:"CIMSymbolReference",symbol:a}};return this.rasterize(z,e,i,v,x,h,r,1,R)}rasterize(y,d,w,f,o,r,s,n=0,M=null){const{data:m}=y;if(!m||m.type!=="CIMSymbolReference"||!m.symbol)return null;const{symbol:C}=m,a=this._canvas,c=(window.devicePixelRatio||1)*$;a.width=d*c,a.height=w*c,s||(s=P(C)),M||(M=D(s,d,w,"legend")),a.width+=2*n,a.height+=2*n;const u=a.getContext("2d",{willReadFrequently:!0}),e=F.createIdentity();return e.translate(-f,-o),e.scale(r*c,-r*c),e.translate(d*c/2+n,w*c/2+n),u.clearRect(0,0,a.width,a.height),new E(u,this._cimResourceManager,e,!0).drawSymbol(C,M),u.getImageData(0,0,a.width,a.height)}}function D(S,y,d,w){const o=-y/2+1,r=y/2-1,s=d/2-1,n=-d/2+1;switch(S){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[o,0],[0,0],[r,0]]]};default:return w==="legend"?{rings:[[[o,s],[r,0],[r,n],[o,n],[o,s]]]}:{rings:[[[o,s],[r,s],[r,n],[o,n],[o,s]]]}}}export{ot as CIMSymbolRasterizer};
