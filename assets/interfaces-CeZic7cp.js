const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ImageMaterial.glsl-BgV2IVLt.js","assets/BindType-BmZEZMMh.js","assets/interfaces-DDtDqZYj.js","assets/Texture-D7jaxJ9P.js","assets/mat3-Dg2BrR6m.js","assets/index-C1aGfQcb.js","assets/index-qkyhuh7d.css","assets/mat3f64-q3fE-ZOt.js","assets/mat4f64-Dk4dwAN8.js","assets/vec32-CmwgPQMd.js","assets/sphere-DuEd_sPX.js","assets/vec42-BHDxGccW.js","assets/vec4f64-o2zAXfmz.js","assets/plane-CM4t6fNH.js","assets/quatf64-aQ5IuZRd.js","assets/vec2f64-CCfZVA9N.js","assets/ViewingMode-HRfKv6NR.js","assets/orientedBoundingBox-DCXdMZSx.js","assets/quat-D8-cBF-l.js","assets/spatialReferenceEllipsoidUtils-BEJMNM9o.js","assets/computeTranslationToOriginAndRotation-C2_ZYUki.js","assets/projectBuffer-CZ7yaGuo.js","assets/VertexAttribute-Cq4MnHjR.js","assets/Util-BK6CBhAA.js","assets/Texture-CLoEFKJJ.js","assets/enums-Dk3osxpS.js","assets/renderState-QDOxIGNB.js","assets/basicInterfaces-CZwQPxTp.js","assets/NormalAttribute.glsl-DGUKFRgB.js","assets/vec2-D9okOEat.js","assets/lengthUtils-CFwdZ3dz.js","assets/boundedPlane-C18Ysvcq.js","assets/lineSegment-C6H8qMyL.js","assets/Indices-NXfq_dEG.js","assets/triangle-CPy2PSEx.js","assets/BufferView-sBvw8vqP.js","assets/AlphaCutoff-UcccL64p.js","assets/requestImageUtils-C-ZsPy5-.js","assets/colorUtils-BWiljOUv.js","assets/elevationInfoUtils-DQT3uSQq.js","assets/ElevationInfo-D7CBP7sd.js","assets/Editor-BZKF0HZM.js","assets/projectVectorToVector-Dtcb6Asj.js","assets/projectPointToVector-ByIVLKML.js","assets/projection-BOBOhWzm.js","assets/Spinner-CEWOvPN4.js","assets/AttachmentInfo-Cg9fIPGU.js","assets/legacyIcon-CEIp6Pa9.js","assets/UpdatingHandles-DOPUoIlu.js","assets/FeatureLayerBase-BNIuOgAL.js","assets/commonProperties-Drl05DKJ.js","assets/HeightModelInfo-kVs8dE0B.js","assets/arcgisLayerUrl-BkZy4Mr3.js","assets/featureLayerUtils-Dy99w2fj.js","assets/Query-LPs1Zyw4.js","assets/FullTextSearch-Cza0yp3f.js","assets/TimeExtent-DGiXUfis.js","assets/timeUtils-X0MXjtQ8.js","assets/jsonUtils-CWFaUb2E.js","assets/UniqueValueRenderer-CAZbf8NT.js","assets/RendererLegendOptions-CULirduz.js","assets/diffUtils-DMLidw0V.js","assets/colorRamps-D4VCsfmX.js","assets/sizeVariableUtils-Cmcuvw-4.js","assets/visualVariableUtils-dx28E4EQ.js","assets/jsonUtils-BWWcP_yB.js","assets/defaults-Dbnhuv3C.js","assets/defaultsJSON-GKolV7NZ.js","assets/styleUtils-CEgUrR2a.js","assets/LRUCache-DbPTy7LA.js","assets/Version-DD-eRUXC.js","assets/FieldsIndex-BrdRr9E_.js","assets/UnknownTimeZone-DhxWDwo9.js","assets/OverrideHelper-D-UVQ00R.js","assets/utils-D7agaEG-.js","assets/enums-CmIX1y88.js","assets/quantizationUtils-DbJV_fl5.js","assets/heatmapUtils-D0BPLm9w.js","assets/LayerFloorInfo-DzoJncEV.js","assets/Relationship-CBhq9gYu.js","assets/serviceCapabilitiesUtils-B23--4px.js","assets/arcade-DfpF5wFh.js","assets/TimeOnly-vNYE6bX9.js","assets/ImmutableArray-BPVd6ESQ.js","assets/FeatureLayer-DGRhhm0K.js","assets/MultiOriginJSONSupport-Qqzd52Lf.js","assets/Layer-CneDw8eF.js","assets/workers-CeelWDzo.js","assets/editsZScale-8GE3gysf.js","assets/queryZScale-D-ZT69l7.js","assets/FeatureSet-CeKoTEEO.js","assets/APIKeyMixin-BrvyKlIW.js","assets/ArcGISService-C1oUW8BT.js","assets/BlendLayer-CG9LFMxd.js","assets/jsonUtils-n3e_wlfQ.js","assets/parser-C4Qiz3JH.js","assets/utils-sqJe3zMg.js","assets/CustomParametersMixin-BhjpsNjD.js","assets/EditBusLayer-DCXZWvgn.js","assets/FeatureEffectLayer-gWJrS8gr.js","assets/FeatureEffect-B5YAe6Lk.js","assets/FeatureReductionLayer-DuxcLofN.js","assets/FeatureReductionSelection-tRCh97wj.js","assets/labelingInfo-BV0df7F6.js","assets/labelUtils-C_ZaLudT.js","assets/MD5-C9MwAd2G.js","assets/OperationalLayer-nNeN4Mrb.js","assets/OrderedLayer-B8Gw_A9P.js","assets/OrderByInfo-k2G4k_zV.js","assets/PortalLayer-Bqf_dhsv.js","assets/portalItemUtils-Cy9KvMYK.js","assets/RefreshableLayer-CwxQNwd3.js","assets/ScaleRangeLayer-66YiyNPI.js","assets/TemporalLayer-CR5q7V2k.js","assets/TimeInfo-CY1-cj-U.js","assets/FeatureTemplate-DJBXu3Te.js","assets/FeatureType-JHO2oVJp.js","assets/fieldProperties-CoDAhoou.js","assets/versionUtils-DBm9Te4x.js","assets/styleUtils-CFywnZa6.js","assets/popupUtils-BA1X4qoc.js","assets/interfaces-CL2NbQte.js","assets/symbolUtils-BmmDXP-E.js","assets/utils-C2gvZghy.js","assets/mat2df32-BR-p9z6z.js","assets/webStyleSymbolUtils-kO7zmqzd.js","assets/GraphicsLayer-7fnK8PA0.js","assets/GraphicsCollection-BlUFPpxh.js","assets/screenUtils-CLE_gLy7.js","assets/signal-CRiDvIIF.js","assets/utils-CS8i_70G.js","assets/drapedUtils-BnpEPkkO.js","assets/infoFor3D-C0hFfS1m.js","assets/utils-BQBvadb7.js","assets/widget-3rB5q3_K.js","assets/uploadAssetErrors-Cy9k5t87.js","assets/SketchTooltipInfo-DuJVRn9_.js","assets/geodesicLengthMeasurementUtils-DHp52l__.js","assets/MeshTransform-CQofocAh.js","assets/axisAngleDegrees-C6bqw-Uy.js","assets/meshVertexSpaceUtils-D5F-abOR.js","assets/MeshLocalVertexSpace-sgg6_SW2.js","assets/themeUtils-C3zvZbsE.js","assets/a11yUtils-Tsw26pQ5.js","assets/memoize-DsJmrG76.js","assets/TextOverlayItem-DKvrqEks.js","assets/Octree-_-EHFyX0.js","assets/RibbonLine.glsl-CJtVy81W.js","assets/utils-OIoyRVPd.js","assets/IntersectorInterfaces-BgX4KEwK.js","assets/hydratedFeatures-ByIq7uy-.js","assets/vec3f32-nZdmKIgz.js","assets/doublePrecisionUtils-B0owpBza.js","assets/InterleavedLayout-Bb_2wUZe.js","assets/types-D0PSWh4d.js","assets/floatRGBA-BxT4aGRY.js","assets/HUDMaterial.glsl-l3I2wjlc.js","assets/VertexArrayObject-CzGu5bI8.js","assets/NestedMap-GuqgquCN.js","assets/glUtil-CFv2RXTA.js","assets/VertexElementDescriptor-BOD-G50G.js","assets/BufferObject-C4qiEJeh.js","assets/automaticAreaMeasurementUtils-B8M9AKp8.js","assets/PointSnappingHint-DLpaNTCp.js","assets/earcut-Lltz9D9k.js","assets/editPlaneUtils-C8xyLzT4.js","assets/Scheduler-DS_v5N7L.js","assets/debugFlags-CfZYxH5Q.js","assets/mat2df64-B7VPBnkO.js","assets/helpMessageUtils3d-BZzQ2OvH.js","assets/SelectedVertexTooltipInfo-ePpFunqV.js","assets/TranslateTooltipInfo-CA9YaD4t.js","assets/IViewEvents-Bci6PjlS.js","assets/persistable-yoZGtoc7.js","assets/multiOriginJSONSupportUtils-C0wm8_Yw.js","assets/resourceExtension-D0H_LB-z.js","assets/ExtentScaleTooltipInfo-CzwmCuLw.js","assets/GraphicManipulator-BMTkDhtD.js"])))=>i.map(i=>d[i]);
import{F as d,T as Pe,G as m,K as U,ay as Ae,dk as Qe,lY as At,lZ as qr,hj as be,cr as Ie,bq as yr,c0 as Xe,jb as It,bT as zr,cV as $t,aE as Ee,M as ce,gw as Ce,ec as Re,aA as jr,b3 as Br,ja as Et,g6 as vt,cY as kr,l_ as Yr,j5 as Qr,e5 as Xr,L as Zr,dm as xr,hw as de,di as Jr,c8 as Kr,l$ as ei,jc as ot,m0 as ti,ga as ri,gc as ii,g5 as si,gD as Cr,hp as ai,gB as Ft}from"./index-C1aGfQcb.js";import{o as Z,e as G}from"./mat4f64-Dk4dwAN8.js";import{j as oi,A as ni,g as li,s as z,r as hi,c as ci,H as di,y as ui,E as wr,o as Tr}from"./vec32-CmwgPQMd.js";import{U as br,E as gi,C as pi}from"./sphere-DuEd_sPX.js";import{m as _i}from"./plane-CM4t6fNH.js";import{r as Mt,s as Rr,n as St,N as mi}from"./vec4f64-o2zAXfmz.js";import{H as Fe}from"./InterleavedLayout-Bb_2wUZe.js";import{n as O,l as nt,C as Lt,h as fi}from"./NormalAttribute.glsl-DGUKFRgB.js";import{o as vi}from"./AlphaCutoff-UcccL64p.js";import{Z as K,ay as Or,Q as yi,o as pe,a2 as xi,a3 as Ci,i as Nt,_ as yt,v as Ht,R as Me,S as Dt,j as we,M as wi,az as Gt,B as $r,U as Le,V as Ne,X as Ti,Y as lt,O as bi,A as D,ag as Je,aA as ht,af as Te,aB as Ri,aC as Oi,aD as $i,ap as A,aE as Si,aF as Di,m as ct,as as Pi,av as Ai,a as Ii,D as Ei,a9 as Fi,F as Mi,I as Li,P as Wt,ab as Ni,e as Hi,aa as Gi,a5 as Wi,ah as Ui,ai as Vi,aj as qi,ak as zi,al as ji,am as Bi,an as ki,ao as Yi,ar as Qi,K as Xi,aq as Zi,at as Ji,aw as Ki,aG as es,aH as ts,p as rs,k as is,t as ss}from"./Texture-D7jaxJ9P.js";import{a as We,e as Pt}from"./basicInterfaces-CZwQPxTp.js";import{e as y}from"./VertexAttribute-Cq4MnHjR.js";import{o as R,t as st}from"./interfaces-DDtDqZYj.js";import{C as Oe,G as as,L as Sr,F as Ut,M as Dr,_ as $e,f as os}from"./enums-Dk3osxpS.js";import{B as Se,c as Pr,g as De,f as ns}from"./renderState-QDOxIGNB.js";import{o as _e,u as Q,l as le,_ as me,b as Vt,e as he,j as S,x as ls,v as qt,r as hs,G as cs}from"./vec2-D9okOEat.js";import{r as ds,n as x}from"./vec2f64-CCfZVA9N.js";import{H as us,n as gs}from"./projectBuffer-CZ7yaGuo.js";import{A as ps}from"./Indices-NXfq_dEG.js";import{l as Ar}from"./ViewingMode-HRfKv6NR.js";import{t as Y}from"./orientedBoundingBox-DCXdMZSx.js";import{p as Ke,a as Ir}from"./triangulationUtils-ss0xSAA3.js";import{t as _s,_ as ms,a as fs,e as Ue,C as vs,b as zt,u as ys}from"./RibbonLine.glsl-CJtVy81W.js";import{r as xs,i as at,s as Cs,n as ws,x as Ts,E as jt,I as dt,f as bs,u as Rs}from"./HUDMaterial.glsl-l3I2wjlc.js";import{e as Os}from"./mat3f64-q3fE-ZOt.js";import{a as $s}from"./BindType-BmZEZMMh.js";import{r as ut}from"./signal-CRiDvIIF.js";import{j as Ss,v as Bt,w as kt}from"./axisAngleDegrees-C6bqw-Uy.js";import{r as Ds,l as Ps,w as As,y as k}from"./HighlightDefaults-D7TbvM-a.js";import{t as et}from"./VertexElementDescriptor-BOD-G50G.js";import{E as Yt}from"./BufferObject-C4qiEJeh.js";import{e as Er,m as tt}from"./Texture-CLoEFKJJ.js";import{t as Is}from"./NestedMap-GuqgquCN.js";import{s as ue,u as Es,c as te,f as Ve}from"./Util-BK6CBhAA.js";import{o as Fs,a as Ms,G as Ls}from"./utils-OIoyRVPd.js";import{s as Qt,z as Ns}from"./vec42-BHDxGccW.js";import{e as Xt,i as Hs}from"./IntersectorInterfaces-BgX4KEwK.js";import"./boundedPlane-C18Ysvcq.js";import{g as Gs,C as Ws}from"./Scheduler-DS_v5N7L.js";var j,rt;function Us(e){return e!=null&&!e.running}(function(e){e[e.Idle=0]="Idle",e[e.Rendering=1]="Rendering",e[e.Ready=2]="Ready",e[e.Fading=3]="Fading"})(j||(j={})),function(e){e[e.RG=0]="RG",e[e.BA=1]="BA",e[e.COUNT=2]="COUNT"}(rt||(rt={}));var xt;let qe=xt=class extends Ae{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new xt({cloudCover:this.cloudCover})}};d([Pe({cloudy:"cloudy"})],qe.prototype,"type",void 0),d([m({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],qe.prototype,"cloudCover",void 0),qe=xt=d([U("esri.views.3d.environment.CloudyWeather")],qe);var Ct;let ze=Ct=class extends Ae{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new Ct({fogStrength:this.fogStrength})}};d([Pe({foggy:"foggy"})],ze.prototype,"type",void 0),d([m({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],ze.prototype,"fogStrength",void 0),ze=Ct=d([U("esri.views.3d.environment.FoggyWeather")],ze);var wt;let fe=wt=class extends Ae{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new wt({cloudCover:this.cloudCover,precipitation:this.precipitation})}};d([Pe({rainy:"rainy"})],fe.prototype,"type",void 0),d([m({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],fe.prototype,"cloudCover",void 0),d([m({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],fe.prototype,"precipitation",void 0),fe=wt=d([U("esri.views.3d.environment.RainyWeather")],fe);var Tt;let re=Tt=class extends Ae{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new Tt({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};d([Pe({snowy:"snowy"})],re.prototype,"type",void 0),d([m({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],re.prototype,"cloudCover",void 0),d([m({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],re.prototype,"precipitation",void 0),d([m({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],re.prototype,"snowCover",void 0),re=Tt=d([U("esri.views.3d.environment.SnowyWeather")],re);var bt;let je=bt=class extends Ae{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new bt({cloudCover:this.cloudCover})}};d([Pe({sunny:"sunny"})],je.prototype,"type",void 0),d([m({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],je.prototype,"cloudCover",void 0),je=bt=d([U("esri.views.3d.environment.SunnyWeather")],je);const Be=1e4,Vs=1e5;var it;(function(e){e[e.Immediate=0]="Immediate",e[e.FadeWithWeather=1]="FadeWithWeather"})(it||(it={}));let qs=class extends Fs{constructor(t,r,i){super(t,r),this.triangleNr=i}};var B,Zt,Jt;(function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"})(B||(B={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(Zt||(Zt={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(Jt||(Jt={}));let Kt=class{constructor(){this._extent=Qe(),this.resolution=0,this.renderLocalOrigin=_s(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new zs}get extent(){return this._extent}setupGeometryViewsCyclical(t){this.setupGeometryView();const r=.001*t.range;if(this._extent[0]-r<=t.min){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];At(this._extent,t.range,0,i)}if(this._extent[2]+r>=t.max){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];At(this._extent,-t.range,0,i)}}setupGeometryView(){this.canvasGeometries.numViews=1,qr(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let t=0;t<this.canvasGeometries.numViews;t++){const r=this.canvasGeometries.extents[t];if(r[0]!==r[2]&&r[1]!==r[3])return!0}return!1}},zs=class{constructor(){this.extents=[Qe(),Qe(),Qe()],this.numViews=0}};var T;(function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.WaterNormal=3]="WaterNormal",e[e.Occluded=4]="Occluded",e[e.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"})(T||(T={}));let js=class{constructor(t,r,i){this._fbos=t,this._format=r,this._name=i}get valid(){var t;return((t=this._handle)==null?void 0:t.getTexture())!=null}dispose(){this._handle=be(this._handle)}get texture(){var t;return(t=this._handle)==null?void 0:t.getTexture()}bind(t,r,i){var s,a,o,n;this._handle&&((s=this._handle.fbo)==null?void 0:s.width)===r&&((a=this._handle.fbo)==null?void 0:a.height)===i||((o=this._handle)==null||o.release(),this._handle=this._fbos.acquire(r,i,this._name,this._format)),t.bindFramebuffer((n=this._handle)==null?void 0:n.fbo)}generateMipMap(){var t,r,i,s,a;(i=(r=(t=this._handle)==null?void 0:t.getTexture())==null?void 0:r.descriptor)!=null&&i.hasMipmap&&((a=(s=this._handle)==null?void 0:s.getTexture())==null||a.generateMipmap())}},ie=class{constructor(t,r,i,s,a=K.RGBA_MIPMAP){this.output=i,this.content=s,this.fbo=new js(t,a,r)}get valid(){return this.fbo.valid}},Bs=class{constructor(t){this.targets=[new ie(t,"overlay color",O.Color,T.Color),new ie(t,"overlay IM color",O.Color,T.ColorNoRasterImage),new ie(t,"overlay highlight",O.Highlight,T.Highlight,K.RGBA),new ie(t,"overlay water",O.Normal,T.WaterNormal),new ie(t,"overlay occluded",O.Color,T.Occluded)],Or()&&this.targets.push(new ie(t,"overlay olid",O.ObjectAndLayerIdColor,T.ObjectAndLayerIdColor,K.RGBA))}getTexture(t){var r;return(r=this.targets[t])==null?void 0:r.fbo.texture}dispose(){for(const t of this.targets)t.fbo.dispose()}computeValidity(){return this.targets.reduce((t,r,i)=>r.valid?t|=1<<i:t,0)}};var er;(function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight",e[e.ViewshedShadowMap=3]="ViewshedShadowMap"})(er||(er={}));class ks{constructor(){this.startTime=0,this._data=ut(null),this._readChannels=rt.RG,this.parallax=new tr,this.parallaxNew=new tr,this._anchorPoint=Ie(),this._fadeState=ut(_.HIDE),this._fadeFactor=ut(1)}get data(){return this._data.value}set data(t){this._data.value=t}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case _.HIDE:return 0;case _.FADE_OUT:return 1-this.fadeFactor;case _.FADE_IN:return this.fadeFactor;case _.SHOW:case _.CROSS_FADE:return 1}}fade(t,r,i){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=i?yr((r-this.startTime)/(Qs*i),0,1):1,this.fadeFactor===1&&this._endFade()),this._evaluateState(t,r),this._updateParallax(t)}_evaluateState(t,r){const i=t.relativeElevation,s=this._updateAnchorPoint(t);(i>1.7*Be||i<-Be||s>ir)&&this.opacity>0?this._startFade(_.HIDE,r):this.isFading||(i>Be||i<-.35*Be||s>Xs*ir?this.opacity>0&&this._startFade(_.FADE_OUT,r):Us(this.data)&&(this.opacity===0?this._startFade(_.FADE_IN,r):this.data.state===j.Ready&&(this.fadeState===_.SHOW?this._startFade(_.CROSS_FADE,r):this._startFade(_.SHOW,r))))}_updateParallax(t){const r=oi(t.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(r-Xe.radius*Xe.radius,0))/Math.sqrt(r),Bt(rr,this.parallax.anchorPoint,se),It(this.parallax.transform,Z,se[3],kt(se)),Bt(rr,this.parallaxNew.anchorPoint,se),It(this.parallaxNew.transform,Z,se[3],kt(se))}_updateAnchorPoint(t){var r;return ni(this._anchorPoint,t.eye),li(this._anchorPoint,this._anchorPoint,Xe.radius),this.fadeState===_.HIDE&&((r=this.data)==null?void 0:r.state)===j.Ready?(z(this.parallax.anchorPoint,this._anchorPoint),0):hi(ci(Ys,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(t,r){switch(this._fadeState.value=t,this.startTime=r,t){case _.CROSS_FADE:this.requestFade(),this._switchReadChannels(),z(this.parallaxNew.anchorPoint,this._anchorPoint);break;case _.FADE_IN:this.requestFade(),this._switchReadChannels(),z(this.parallax.anchorPoint,this._anchorPoint),z(this.parallaxNew.anchorPoint,this._anchorPoint);break;case _.FADE_OUT:this.requestFade();break;case _.SHOW:this._switchReadChannels(),z(this.parallax.anchorPoint,this._anchorPoint),z(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case _.HIDE:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==j.Ready&&(this.data.state=j.Idle),this.fadeState){case _.CROSS_FADE:z(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=_.SHOW;break;case _.FADE_IN:this._fadeState.value=_.SHOW;break;case _.FADE_OUT:this._fadeState.value=_.HIDE;break;case _.SHOW:case _.HIDE:break;default:zr(this.fadeState)}}_switchReadChannels(){var t;((t=this.data)==null?void 0:t.state)===j.Ready&&(this._readChannels=1-this._readChannels,this.data.state=j.Fading)}get isFading(){return this.fadeState===_.FADE_OUT||this.fadeState===_.FADE_IN||this.fadeState===_.CROSS_FADE}}var _;(function(e){e[e.HIDE=0]="HIDE",e[e.FADE_IN=1]="FADE_IN",e[e.SHOW=2]="SHOW",e[e.CROSS_FADE=3]="CROSS_FADE",e[e.FADE_OUT=4]="FADE_OUT"})(_||(_={}));let tr=class{constructor(){this.anchorPoint=Ie(),this.radiusCurvatureCorrection=0,this.transform=G()}};const rr=$t(0,0,1),se=Ss(),Ys=Ie(),Qs=1.25,Xs=.5,ir=2e5;let Zs=class extends yi{constructor(t,r){super(t,"samplerCube",$s.Pass,(i,s,a)=>i.bindTexture(t,r(s,a)))}};function Qo(e){const t=e.fragment;t.constants.add("radiusCloudsSquared","float",Js).code.add(R`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos) {
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusCloudsSquared;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
return (cameraPosition + dir * pointIntDist) - spherePos;
}`),t.uniforms.add(new pe("radiusCurvatureCorrection",(l,h)=>h.clouds.parallax.radiusCurvatureCorrection)).code.add(R`vec3 correctForPlanetCurvature(vec3 dir) {
dir.z = dir.z * (1.0 - radiusCurvatureCorrection) + radiusCurvatureCorrection;
return dir;
}`),t.code.add(R`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec) {
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),xi(t),Ci(t);const r=$t(.28,.175,.035);t.constants.add("RIM_COLOR","vec3",r),t.code.add(R`
    vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds) {
      float upDotLight = dot(cameraPosition, mainLightDirection);
      float dirDotLight = max(dot(worldSpaceRay, mainLightDirection), 0.0);
      float sunsetTransition = clamp(pow(max(upDotLight, 0.0), ${R.float(.3)}), 0.0, 1.0);

      // Base color of the clouds that depends on lighting of the sun and sky
      vec3 ambientLight = calculateAmbientIrradiance(cameraPosition,  0.0);
      vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
      vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));

      // Rim light around the edge of the clouds simulating scattering of the direct lun light
      float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
      float rimLightIntensity = 0.5 + 0.5 * pow(max(upDotLight, 0.0), 0.35);
      vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, ${R.float(140)})) * scatteringMod;

      // Brighten the clouds around the sun at the sunsets
      float additionalLight = ${R.float(.2)} * pow(dirDotLight, ${R.float(10)}) * (1. - pow(sunsetTransition, ${R.float(.3)})) ;

      return vec3(baseCloudColor * (1.0 + additionalLight) + directSunScattering);
    }
  `),t.uniforms.add(new Nt("readChannelsRG",(l,h)=>h.clouds.readChannels===rt.RG),new Zs("cubeMap",(l,h)=>{var u,g;return((g=(u=h.clouds.data)==null?void 0:u.cubeMap)==null?void 0:g.colorTexture)??null})).code.add(R`vec4 sampleCloud(vec3 rayDir, bool readOtherChannel) {
vec4 s = texture(cubeMap, rayDir);
bool readRG = readChannelsRG ^^ readOtherChannel;
s = readRG ? vec4(vec3(s.r), s.g) : vec4(vec3(s.b), s.a);
return length(s) == 0.0 ? vec4(s.rgb, 1.0) : s;
}`),t.uniforms.add(new yt("anchorPoint",(l,h)=>h.clouds.parallax.anchorPoint),new yt("anchorPointNew",(l,h)=>h.clouds.parallaxNew.anchorPoint),new Ht("rotationClouds",(l,h)=>h.clouds.parallax.transform),new Ht("rotationCloudsNew",(l,h)=>h.clouds.parallaxNew.transform),new pe("cloudsOpacity",(l,h)=>h.clouds.opacity),new pe("fadeFactor",(l,h)=>h.clouds.fadeFactor),new Nt("crossFade",(l,h)=>h.clouds.fadeState===_.CROSS_FADE)).code.add(R`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition) {
vec3 intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPoint);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = sampleCloud(worldRayRotatedCorrected, crossFade);
vec3 cameraPositionN = normalize(cameraPosition);
vec4 cloudColor = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
if(crossFade) {
intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPointNew);
worldRayRotated = rotateDirectionToAnchorPoint(rotationCloudsNew, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = sampleCloud(worldRayRotatedCorrected, false);
vec4 cloudColorNew = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorNew, fadeFactor);
}
float totalTransmittance = length(cloudColor.rgb) == 0.0 ?
1.0 :
clamp(cloudColor.a * cloudsOpacity + (1.0 - cloudsOpacity), 0.0 , 1.0);
return vec4(cloudColor.rgb, totalTransmittance);
}`)}const Js=(Xe.radius+Vs)**2;var ge;(function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"})(ge||(ge={}));let Fr=class extends st{constructor(){super(...arguments),this.color=$t(1,1,1)}};function Ks(){const e=new Me;return e.include(Dt),e.fragment.uniforms.add(new we("tex",t=>t.texture),new yt("uColor",t=>t.color)),e.fragment.main.add(R`vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);`),e}const ea=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:Fr,build:Ks},Symbol.toStringTag,{value:"Module"}));let Mr=class extends st{};function ta(){const e=new Me,{outputs:t,fragment:r}=e;return e.include(Dt),r.uniforms.add(new wi("textureInput",i=>i.input)),r.constants.add("outlineWidth","int",Math.ceil(Lr)),r.constants.add("cellSize","int",J),t.add("fragGrid","vec2"),r.main.add(R`vec2 inputTextureSize = vec2(textureSize(textureInput, 0));
vec2 cellBottomLeftCornerInput = floor(gl_FragCoord.xy) * vec2(cellSize);
vec2 coordMid =  (cellBottomLeftCornerInput + 0.5 * vec2(cellSize)) / inputTextureSize;
vec4 commonValue = texture(textureInput, coordMid);
int margin = outlineWidth;
float marginSquare = float(margin*margin);
for(int y = -margin; y <= cellSize + margin; y+=2) {
int dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;
int xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : margin;
for(int x = -xMargin; x <= cellSize + xMargin; x+=2) {
vec2 coord = (cellBottomLeftCornerInput + vec2(x, y)) / inputTextureSize;
vec4 value = texture(textureInput, coord);
if (value != commonValue){
fragGrid = vec2(1.0, 1.0);
return;
}
}
}
bool hasAny = commonValue != vec4(0.0);
fragGrid = vec2(hasAny ? 1.0 : 0.0, 0.0);`),e}const J=32,Lr=9,ra=.4,ia=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:Mr,blurSize:ra,build:ta,gridCellPixelSize:J,outlineSize:Lr},Symbol.toStringTag,{value:"Module"}));function sa(){const e=new Me,{vertex:t,fragment:r}=e;return t.uniforms.add(new we("coverageTexture",i=>i.coverageTexture),new Gt("highlightRenderCellCount",i=>[i.horizontalCellCount,i.verticalCellCount]),new Gt("highlightTextureResolution",i=>[i.highlightTexture.descriptor.width,i.highlightTexture.descriptor.height])),t.constants.add("cellSize","int",J),e.varyings.add("sUV","vec2"),e.varyings.add("vOutlinePossible","float"),t.code.add(R`const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));`),t.main.add(R`int cellIndex = gl_InstanceID;
int cellX = cellIndex % highlightRenderCellCount[0];
int cellY = (cellIndex - cellX) / highlightRenderCellCount[0];
ivec2 cellPos = ivec2(cellX, cellY);
vec4 cov = texelFetch(coverageTexture, cellPos, 0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
return;
}
vOutlinePossible = cov.g;
ivec2 iPosInCell = cellVertices[gl_VertexID];
vec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));
sUV = sPos;
vec2 vPos = sPos / vec2(highlightTextureResolution);
gl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);`),r.uniforms.add(new we("highlightTexture",i=>i.highlightTexture),new we("highlightOptionsTexture",i=>i.highlightOptionsTexture),new pe("pixelRatio",i=>i.pixelRatio),new pe("occludedIntensityFactor",i=>i.occludedFactor),new $r("maxHighlightLevel",i=>i.maxHighlightLevel)),r.constants.add("pixelSampleScale","float",1),r.code.add(R`const float pascal17[9] = float[9](12870.0, 11440.0, 8008.0, 4368.0, 1820.0, 560.0, 120.0, 16.0, 1.0);
const float denom17 =  65536.0;
float colorWeight[16] = float[16](0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
float colorOcclusion[16] = float[16](0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
float weights[16] = float[16](0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);
uint readChannelBits(uint channel, int highlightIndex) {
int llc = (highlightIndex & 3) << 1;
return (channel >> llc) & 3u;
}
uint readChannel(vec4 texel, int highlightIndex) {
int lic = (highlightIndex >> 2) & 3;
return uint(texel[lic] * 255.0);
}
uint readLevelBits(vec4 texel, int highlightIndex) {
return readChannelBits(readChannel(texel, highlightIndex), highlightIndex);
}
void applyTexel(vec4 texel, float weight) {
if (texel != vec4(0.0)){
int maxChannel = maxHighlightLevel >> 2;
for (int channelIndex = 0; channelIndex <= maxChannel; ++channelIndex){
uint channel = readChannel(texel, channelIndex << 2);
int firstIndex = channelIndex << 2;
int maxIndex  = min(firstIndex + 3, maxHighlightLevel);
for (int highlightIndex = firstIndex; highlightIndex <= maxIndex; ++highlightIndex ) {
uint v = readChannelBits(channel, highlightIndex);
if ((v & 1u) == 1u){
colorWeight[highlightIndex] += weight;
if ((v & 2u) == 2u){
colorOcclusion[highlightIndex] += weight;
}
}
}
}
}
}
vec4 readTexel(ivec2 iuv, int du, int dv) {
return texelFetch(highlightTexture, iuv + ivec2(du, dv), 0);
}
void readAndApplyTexel(ivec2 iuv, int du, int dv, float weight) {
vec4 texel = readTexel(iuv, du, dv);
applyTexel(texel, weight);
}
void readAndApply2TexelsU(ivec2 iuv, int du, int dv, float weight) {
readAndApplyTexel(iuv, -du, dv, weight);
readAndApplyTexel(iuv, +du, dv, weight);
}
float getWeight(int pixelDistance) {
float scaledDistance = float(pixelDistance) * pixelSampleScale / pixelRatio;
float d0f = floor(scaledDistance);
int d0 = int(d0f);
if (d0 >= 8){
return 0.0;
}
float w0 = pascal17[d0];
float w1 = pascal17[d0+1];
float f =  scaledDistance - d0f;
return mix(w0, w1, f);
}`),r.main.add(R`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
ivec2 iuv = ivec2(sUV);
vec4 centerTexel = texelFetch(highlightTexture, iuv, 0);
bool outlinePossible = false;
if (vOutlinePossible > 0.0){
for (int highlightLevel=0; highlightLevel<= maxHighlightLevel; ++highlightLevel) {
if ((readLevelBits(centerTexel,highlightLevel) & 1u) == 0u) {
outlinePossible = true;
break;
}
}
}
if (outlinePossible) {
int maxPixelDistance = clamp(int(8.0 * pixelRatio / pixelSampleScale), 2, 16);
float weightSum = 0.0;
for(int y = 0; y <= maxPixelDistance; ++y) {
float w = getWeight(y);
weights[y] = w;
weightSum += w * (y == 0 ? 1.0 : 2.0);
}
for(int y = 0; y <= maxPixelDistance; ++y) {
weights[y] = weights[y] / weightSum;
}
float weight0 = weights[0];
applyTexel(centerTexel, weight0 * weight0);
for(int y = 0; y <= maxPixelDistance; y += 1) {
float yFactor = weights[y];
if (y != 0) {
float xFactor = weight0;
float weight = xFactor * yFactor;
if (weight > 0.0) {
readAndApplyTexel(iuv, 0, +y, weight);
readAndApplyTexel(iuv, 0, -y, weight);
}
}
for(int x = 1; x <= maxPixelDistance; x += 1) {
float xFactor = weights[x];
float weight = xFactor * yFactor;
if (weight > 0.0) {
readAndApply2TexelsU(iuv, x, +y, weight);
if (y != 0){
readAndApply2TexelsU(iuv, x, -y, weight);
}
}
}
}
} else {
applyTexel(centerTexel, 1.0);
}
int frontColorIndex = 999;
int maxColorIndex = 0;
for (int i = 0; i <= maxHighlightLevel; ++i) {
if (colorWeight[i] > 0.0){
frontColorIndex = min(frontColorIndex, i);
maxColorIndex = max(maxColorIndex, i);
}
}
if (frontColorIndex == 999){
fragColor = vec4(0.0);
return;
}
vec4 accumulatedColor = vec4(0.0);
for (int curColorIndex = frontColorIndex; curColorIndex <= maxColorIndex; ++curColorIndex) {
float curColorWeight = colorWeight[curColorIndex];
if (curColorWeight <= 0.01){
continue;
}
uint vc = readLevelBits(centerTexel, curColorIndex);
bool centerFilled = (vc & 1u) == 1u;
bool centerOccluded = (vc & 3u) == 3u;
float curColorOcclusion = colorOcclusion[curColorIndex];
bool occluded = centerFilled ? centerOccluded : curColorOcclusion > 0.5 * curColorWeight;
int colorChannel = centerFilled ? 0 : 1;
vec4 colorBase = texelFetch(highlightOptionsTexture, ivec2(curColorIndex, colorChannel), 0);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, 0.03, curColorWeight);
float intensity = colorBase.a * occlusionFactor * outlineFactor;
vec3 currentColor = colorBase.rgb;
float a0 = accumulatedColor.a;
float a1 = intensity;
float alpha = clamp(a0 + a1 - a0 * a1, 0.0, 1.0);
if (alpha > 0.001){
vec3 blendedColor = ((1.0 - a1) * a0 * accumulatedColor.rgb + a1 * currentColor) / alpha;
accumulatedColor = vec4(blendedColor, alpha);
}
}
fragColor = accumulatedColor;`),e}const aa=Object.freeze(Object.defineProperty({__proto__:null,build:sa},Symbol.toStringTag,{value:"Module"}));let sr=class extends Le{constructor(t,r,i){super(t,r,new Ne(aa,()=>Ee(()=>import("./ImageMaterial.glsl-BgV2IVLt.js").then(s=>s.H),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177]))),i)}initializePipeline(){return Se({blending:Pr,colorWrite:De})}},ar=class extends Le{constructor(t,r,i){super(t,r,new Ne(ia,()=>Ee(()=>import("./ImageMaterial.glsl-BgV2IVLt.js").then(s=>s.a),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177]))),i)}initializePipeline(){return Se({colorWrite:De})}},oa=class extends st{constructor(){super(...arguments),this.color=Mt(1,0,1,1),this.haloColor=Mt(1,0,1,1),this.haloOpacity=Ds,this.fillOpacity=Ps,this.occludedFactor=As,this.maxHighlightLevel=1,this.coverageRounding=ds(1,1),this.verticalCellCount=0,this.horizontalCellCount=0,this.pixelRatio=1}};const na=[];new et(y.POSITION,3,Oe.FLOAT,0,12);new et(y.POSITION,2,Oe.FLOAT,0,8);new et(y.POSITION,2,Oe.FLOAT,0,16),new et(y.UV0,2,Oe.FLOAT,8,16);let ve=class extends Ti{constructor(e){super(e),this.produces=lt.HIGHLIGHTS,this.consumes={required:[lt.HIGHLIGHTS,"highlights"]},this._optionsTexture=null,this._downsampleDrawParameters=new Mr,this._passParameters=new oa,this._grid=new la,e.techniques.precompile(ar),e.techniques.precompile(sr)}initialize(){const{view:e}=this,{highlights:t}=e;this.addHandles([ce(()=>Hr(t),()=>{this._optionsTexture=Re(this._optionsTexture),this.requestRender(We.UPDATE)},Ce),ce(()=>t,()=>{this.requestRender(We.UPDATE)},Ce),t.on("after-changes",()=>{this.requestRender(We.UPDATE)})])}destroy(){this._passParameters&&(this._passParameters.highlightOptionsTexture=null),this._grid.coverage=be(this._grid.coverage),this._grid.vao=Re(this._grid.vao),this._optionsTexture=be(this._optionsTexture)}_updateOptionsTexture(e){const t=this.renderingContext;let r=this._optionsTexture;if(r==null){const i=new Er(16,2);i.internalFormat=as.RGBA,i.samplingMode=Sr.NEAREST,r=new tt(t,i,null),this._optionsTexture=r}r.setData(e),this._passParameters.highlightOptionsTexture=r}render(e){var ee,He;const t=e.find(({name:W})=>W===lt.HIGHLIGHTS);if(!this.bindParameters.decorations)return t;const{techniques:r,bindParameters:i,_grid:s}=this,a=r.acquire(ar),o=r.acquire(sr);if(!a.compiled||!o.compiled)return this.requestRender(We.UPDATE),t;const{highlights:n}=this.view;this._optionsTexture==null&&this._updateOptionsTexture(ha(n));const l=e.find(({name:W})=>W==="highlights").getTexture(),h=i.camera,{_passParameters:u}=this;u.highlightOptionsTexture=this._optionsTexture,this._passParameters.pixelRatio=h.pixelRatio;const g=this.renderingContext;this._gridUpdateResources(l),this._gridComputeCoverage(a,l,i),a.release(),u.highlightTexture=l,u.coverageTexture=(ee=s.coverage)==null?void 0:ee.getTexture();const{horizontalCellCount:f,verticalCellCount:v}=s;u.horizontalCellCount=f,u.verticalCellCount=v;const C=new Set;for(let W=0;W<k;++W){const Ge=(He=n.at(W))==null?void 0:He.name;Ge&&C.add(Ge)}u.maxHighlightLevel=C.size-1,g.bindVAO(s.vao),g.bindFramebuffer(t.fbo),g.setViewport4fv(h.fullViewport),g.bindTechnique(o,i,u);const V=v*f;return g.drawElementsInstanced(o.primitiveType,6,Oe.UNSIGNED_BYTE,0,V),o.release(),t}_gridUpdateResources(e){const t=this.renderingContext,r=this._grid,{width:i,height:s}=e.descriptor;if(r.horizontalCellCount=Math.ceil(i/J),r.verticalCellCount=Math.ceil(s/J),r.vao)return;const a=Yt.createIndex(t,Ut.STATIC_DRAW,da);r.vao=new xs(t,bi,new Map([["geometry",na]]),new Map([["geometry",Yt.createVertex(t,Ut.STATIC_DRAW)]]),a)}_gridComputeCoverage(e,t,r){var h;const i=this.renderingContext,s=this._grid,a=t.descriptor,o=Math.ceil(a.width/J),n=Math.ceil(a.height/J);this._downsampleDrawParameters.input=t,(h=s.coverage)==null||h.release();const l=this.fboCache.acquire(o,n,"highlight coverage",K.RG);s.coverage=l,i.bindFramebuffer(l.fbo),i.bindTechnique(e,r,this._passParameters,this._downsampleDrawParameters),i.setViewport(0,0,o,n),i.screen.draw()}get test(){}};d([m()],ve.prototype,"produces",void 0),d([m()],ve.prototype,"consumes",void 0),d([m({constructOnly:!0})],ve.prototype,"techniques",void 0),ve=d([U("esri.views.3d.webgl-engine.effects.highlight.Highlight")],ve);let la=class{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}};function ha(e){const t=new Uint8Array(128),r=(s,a)=>{t[s]=a},i=(s,a)=>{const o=4*s,n=4*s+64,{color:l}=a,h=a.haloColor??l;r(o+0,l.r),r(o+1,l.g),r(o+2,l.b),r(o+3,a.fillOpacity*l.a*255),r(n+0,h.r),r(n+1,h.g),r(n+2,h.b),r(n+3,a.haloOpacity*h.a*255)};return Nr(e,(s,a)=>{i(a,s.options)}),t}const or=new Array(k),nr=new Array(k);function Nr(e,t){const r=Math.min(e.length,k);let i=k;for(let a=r-1;a>=0;--a){const o=e.at(a);if(o){const n=o.name;or.includes(n,i)||(--i,or[i]=n,nr[i]=a)}}const s=k-i;for(let a=0;a<s;++a){const o=nr[k-s+a];t(e.at(o),a)}}let ca=0;function Hr(e){let t=0;const r=Math.min(k,e.length);for(let i=0;i<r;++i){const s=e.at(i);if(s){const{name:a,options:o}=s;t+=a.length;const{color:n,fillOpacity:l,haloColor:h,haloOpacity:u}=o;t+=n.r+n.g+n.b+n.a+l,t+=h?h.r+h.g+h.b+h.a+u:0}}{const i=e.at(0);if(i){const{shadowOpacity:s,shadowDifference:a,shadowColor:o}=i.options;t+=s+a+o.r+o.g+o.b+o.a}}return ca++}const da=new Uint8Array([0,1,2,2,1,3]);function ua(e,t,r,i,s,a,o=0,n){const{highlightGroupIndices:l}=s;l.clear();const h=[];Nr(i,C=>{const{name:V}=C;l.set(V,h.length),h.push(V)});const u=l.size,{gl:g}=e;_e(s.highlightMixOrigin,o,0);let f=null;u>1&&(f=t.acquire(r.width,r.height,"highlight mix",K.RGBA),e.bindFramebuffer(f.fbo),e.clearFramebuffer(Rr));const v=(f==null?void 0:f.getTexture())??null;s.highlightMixTexture=v,n();for(let C=0;C<u;++C)C>0&&(e.bindTexture(v,0),g.copyTexSubImage2D(Dr.TEXTURE_2D,0,0,0,o,0,r.width,r.height),e.bindTexture(null,0)),e.clear($e.DEPTH),s.highlightLevel=C,s.highlightGroupName=h[C],a();f==null||f.release()}let ga=class{constructor(t,r,i,s){this._textures=t,this._techniques=r,this.materialChanged=i,this.requestRender=s,this._id2glMaterialRef=new Is}dispose(){this._textures.destroy()}acquire(t,r,i){this._ownMaterial(t);const s=t.produces.get(r);if(!(s!=null&&s(i)))return null;let a=this._id2glMaterialRef.get(i,t.id);if(a==null){const o=t.createGLMaterial({material:t,techniques:this._techniques,textures:this._textures,output:i});a=new pa(o),this._id2glMaterialRef.set(i,t.id,a)}return a.ref(),a.glMaterial}release(t,r){const i=this._id2glMaterialRef.get(r,t.id);i!=null&&(i.unref(),i.referenced||(Re(i.glMaterial),this._id2glMaterialRef.delete(r,t.id)))}_ownMaterial(t){t.repository&&t.repository!==this&&jr.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),t.repository=this}},pa=class{constructor(t){this.glMaterial=t,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,ue(this._refCnt>=0)}get referenced(){return this._refCnt>0}},_a=class{constructor(t){this.shadowMap=t,this.slot=D.OPAQUE_MATERIAL,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=Je.NONE,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new at,this._inverseViewport=x(),this._oldLighting=new ht,this._newLighting=new ht,this._fadedLighting=new ht,this._lighting=this._newLighting,this.ssr=new ma,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlightMixTexture=null,this.highlightGroupName=null,this.highlightGroupIndices=new Map,this.highlightLevel=0,this.highlightMixOrigin=x(),this.hudRenderStyle=Ms.Occluded,this.clouds=new ks,this.shadowHighlightsVisible=!1}get camera(){return this._camera}set camera(t){this._camera=t,this._inverseViewport[0]=1/t.fullViewport[2],this._inverseViewport[1]=1/t.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(t,r,i,s){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=r,this._newLighting.globalFactor=i,this._newLighting.set(t),s===it.FadeWithWeather&&this.clouds.requestFade(),this.fadeLighting()}},ma=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=G()}},fa=class{constructor(t,r){this.rctx=t,this.lastFrameCamera=new at,this.output=O.Color,this.renderOccludedMask=Ze,this.bind=new _a(r),this.bind.alignPixelEnabled=!0}};const Ze=Te.Occlude|Te.OccludeAndTransparent|Te.OccludeAndTransparentStencil;let xe=class extends at{constructor(){super(...arguments),this._projectionMatrix=G()}get projectionMatrix(){return this._projectionMatrix}};d([m()],xe.prototype,"_projectionMatrix",void 0),d([m({readOnly:!0})],xe.prototype,"projectionMatrix",null),xe=d([U("esri.views.3d.webgl-engine.lib.CascadeCamera")],xe);var Rt;(function(e){e[e.Highlight=0]="Highlight",e[e.ExcludeHighlight=1]="ExcludeHighlight"})(Rt||(Rt={}));class ke{constructor(){this.camera=new xe,this.lightMat=G()}}class va{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class ya{constructor(t,r){this._fbos=t,this._viewingMode=r,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new va,this._projectionView=G(),this._projectionViewInverse=G(),this._modelViewLight=G(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=St(),this._cascades=[new ke,new ke,new ke,new ke],this._lastOrigin=null,this._maxTextureWidth=Math.min(Br("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){var t;return(t=this._handle)==null?void 0:t.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return Qt(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeOffscreenBuffers(){this._handle=be(this._handle),this._discardSnapshots()}set maxCascades(t){this.settings.maxNumCascadesHighQuality=yr(Math.floor(t),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(t){this._enabled=t,t||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let t=0;t<this._numCascades;++t)pt[t]=this._cascades[t];return pt.length=this._numCascades,pt}start(t,r,i,s,a){ue(this.enabled);const{near:o,far:n}=Ra(i);this._computeCascadeDistances(o,n,s),this._textureHeight=this._computeTextureHeight(t,a,s),this._setupMatrices(t,r);const{viewMatrix:l,projectionMatrix:h}=t;for(let u=0;u<this._numCascades;++u)this._constructCascade(u,h,l,r);this._lastOrigin=null,this.clear()}finish(){var t;ue(this.enabled),(t=this._handle)==null||t.detachDepth()}getShadowMapMatrices(t){if(!this._lastOrigin||!di(t,this._lastOrigin)){this._lastOrigin=this._lastOrigin||Ie(),z(this._lastOrigin,t);for(let r=0;r<this._numCascades;++r){Et(gr,this._cascades[r].lightMat,t);for(let i=0;i<16;++i)pr[16*r+i]=gr[i]}}return pr}moveSnapshot(t){var r,i;ue(this.enabled),(r=this._handle)==null||r.detachDepth(),(i=this._snapshots[t])==null||i.release(),this._snapshots[t]=this._handle,this._handle=null,this.clear()}copySnapshot(t){var l,h,u,g;const r=(h=(l=this._handle)==null?void 0:l.getTexture())==null?void 0:h.descriptor;if(!this.enabled||!r)return;(u=this._snapshots[t])==null||u.release();const{width:i,height:s}=r,a=t===Rt.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot";this._snapshots[t]=this._fbos.acquire(i,s,a,K.RGBA4);const o=this._fbos.rctx;this._bindFbo();const n=o.bindTexture((g=this._snapshots[t])==null?void 0:g.getTexture(),tt.TEXTURE_UNIT_FOR_UPDATES);o.gl.copyTexSubImage2D(Dr.TEXTURE_2D,0,0,0,0,0,i,s),o.bindTexture(n,tt.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(t){var r;return this.enabled?(r=this._snapshots[t])==null?void 0:r.getTexture():null}clear(){const t=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),t.setClearColor(1,1,1,1),t.clear($e.COLOR|$e.DEPTH)}_computeTextureHeight(t,r,i){const s=Math.min(window.devicePixelRatio,r)/t.pixelRatio,a=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,o=Ri(Math.floor(Math.max(t.fullWidth,t.fullHeight)*s*a)),n=Math.min(this._maxTextureWidth,this._numCascades*o);return Oi(n/this._numCascades)}_ensureFbo(){var t,r,i,s,a;((r=(t=this._handle)==null?void 0:t.fbo)==null?void 0:r.width)===this._textureWidth&&((i=this._handle)==null?void 0:i.fbo.height)===this._textureHeight||((s=this._handle)==null||s.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",K.RGBA4)),(a=this._handle)==null||a.acquireDepth($i.DEPTH16_BUFFER)}_discardSnapshot(t){this._snapshots[t]=be(this._snapshots[t])}_discardSnapshots(){for(let t=0;t<this._snapshots.length;++t)this._discardSnapshot(t);this._snapshots.length=0}_bindFbo(){var t;this._fbos.rctx.bindFramebuffer((t=this._handle)==null?void 0:t.fbo)}_constructCascade(t,r,i,s){const a=this._cascades[t],o=-this._cascadeDistances[t],n=-this._cascadeDistances[t+1],l=(r[10]*o+r[14])/Math.abs(r[11]*o+r[15]),h=(r[10]*n+r[14])/Math.abs(r[11]*n+r[15]);ue(l<h);for(let v=0;v<8;++v){Qt(lr,v%4==0||v%4==3?-1:1,v%4==0||v%4==1?-1:1,v<4?l:h,1);const C=N[v];Ns(C,lr,this._projectionViewInverse),C[0]/=C[3],C[1]/=C[3],C[2]/=C[3]}ui(gt,N[0]),a.camera.viewMatrix=Et(xa,this._modelViewLight,gt);for(let v=0;v<8;++v)wr(N[v],N[v],a.camera.viewMatrix);let u=N[0][2],g=N[0][2];for(let v=1;v<8;++v)u=Math.min(u,N[v][2]),g=Math.max(g,N[v][2]);u-=200,g+=200,a.camera.near=-g,a.camera.far=-u,ba(i,s,u,g,a.camera),vt(a.lightMat,a.camera.projectionMatrix,a.camera.viewMatrix);const f=this._textureHeight;a.camera.viewport=[t*f,0,f,f]}_setupMatrices(t,r){vt(this._projectionView,t.projectionMatrix,t.viewMatrix),kr(this._projectionViewInverse,this._projectionView);const i=this._viewingMode===Ar.Global?t.eye:Tr(gt,0,0,1);Yr(this._modelViewLight,[0,0,0],[-r[0],-r[1],-r[2]],i)}_computeCascadeDistances(t,r,i){const s=i?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(Es(r/t,4)),s);const a=(r-t)/this._numCascades,o=(r/t)**(1/this._numCascades);let n=t,l=t;for(let h=0;h<this._numCascades+1;++h)this._cascadeDistances[h]=Qr(n,l,this.settings.splitSchemeLambda),n*=o,l+=a}get test(){}}const xa=G(),lr=St(),N=[];for(let e=0;e<8;++e)N.push(St());const hr=x(),cr=x(),Ca=x(),dr=x(),ur=x(),gt=Ie(),pt=[],gr=G(),pr=Z.concat(Z,Z,Z,Z),M=x(),ae=x(),X=[x(),x(),x(),x()],b=x(),_t=x(),q=x(),ye=x(),oe=x(),ne=x(),Ye=x();function wa(e,t,r,i,s,a,o,n){_e(M,0,0);for(let w=0;w<4;++w)Q(M,M,e[w]);le(M,M,.25),_e(ae,0,0);for(let w=4;w<8;++w)Q(ae,ae,e[w]);le(ae,ae,.25),me(X[0],e[4],e[5],.5),me(X[1],e[5],e[6],.5),me(X[2],e[6],e[7],.5),me(X[3],e[7],e[4],.5);let l=0,h=Vt(X[0],M);for(let w=1;w<4;++w){const F=Vt(X[w],M);F<h&&(h=F,l=w)}he(b,X[l],e[l+4]);const u=b[0];let g,f;b[0]=-b[1],b[1]=u,he(_t,ae,M),S(_t,b)<0&&ls(b,b),me(b,b,_t,r),qt(b,b),g=f=S(he(q,e[0],M),b);for(let w=1;w<8;++w){const F=S(he(q,e[w],M),b);F<g?g=F:F>f&&(f=F)}hs(i,M),le(q,b,g-t),Q(i,i,q);let v=-1,C=1,V=0,ee=0;for(let w=0;w<8;++w){he(ye,e[w],i),qt(ye,ye);const F=b[0]*ye[1]-b[1]*ye[0];F>0?F>v&&(v=F,V=w):F<C&&(C=F,ee=w)}te(v>0,"leftArea"),te(C<0,"rightArea"),le(oe,b,g),Q(oe,oe,M),le(ne,b,f),Q(ne,ne,M),Ye[0]=-b[1],Ye[1]=b[0];const He=Ve(i,e[ee],ne,Q(q,ne,Ye),1,s),W=Ve(i,e[V],ne,q,1,a),Ge=Ve(i,e[V],oe,Q(q,oe,Ye),1,o),Vr=Ve(i,e[ee],oe,q,1,n);te(He,"rayRay"),te(W,"rayRay"),te(Ge,"rayRay"),te(Vr,"rayRay")}function p(e,t){return 3*t+e}const _r=x();function E(e,t){return _e(_r,e[t],e[t+3]),_r}const P=x(),c=Os();function Ta(e,t,r,i,s){he(P,r,i),le(P,P,.5),c[0]=P[0],c[1]=P[1],c[2]=0,c[3]=P[1],c[4]=-P[0],c[5]=0,c[6]=P[0]*P[0]+P[1]*P[1],c[7]=P[0]*P[1]-P[1]*P[0],c[8]=1,c[p(0,2)]=-S(E(c,0),e),c[p(1,2)]=-S(E(c,1),e);let a=S(E(c,0),r)+c[p(0,2)],o=S(E(c,1),r)+c[p(1,2)],n=S(E(c,0),i)+c[p(0,2)],l=S(E(c,1),i)+c[p(1,2)];a=-(a+n)/(o+l),c[p(0,0)]+=c[p(1,0)]*a,c[p(0,1)]+=c[p(1,1)]*a,c[p(0,2)]+=c[p(1,2)]*a,a=1/(S(E(c,0),r)+c[p(0,2)]),o=1/(S(E(c,1),r)+c[p(1,2)]),c[p(0,0)]*=a,c[p(0,1)]*=a,c[p(0,2)]*=a,c[p(1,0)]*=o,c[p(1,1)]*=o,c[p(1,2)]*=o,c[p(2,0)]=c[p(1,0)],c[p(2,1)]=c[p(1,1)],c[p(2,2)]=c[p(1,2)],c[p(1,2)]+=1,a=S(E(c,1),t)+c[p(1,2)],o=S(E(c,2),t)+c[p(2,2)],n=S(E(c,1),r)+c[p(1,2)],l=S(E(c,2),r)+c[p(2,2)],a=-.5*(a/o+n/l),c[p(1,0)]+=c[p(2,0)]*a,c[p(1,1)]+=c[p(2,1)]*a,c[p(1,2)]+=c[p(2,2)]*a,a=S(E(c,1),t)+c[p(1,2)],o=S(E(c,2),t)+c[p(2,2)],n=-o/a,c[p(1,0)]*=n,c[p(1,1)]*=n,c[p(1,2)]*=n,s[0]=c[0],s[1]=c[1],s[2]=0,s[3]=c[2],s[4]=c[3],s[5]=c[4],s[6]=0,s[7]=c[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=c[6],s[13]=c[7],s[14]=0,s[15]=c[8]}function ba(e,t,r,i,s){const a=1/N[0][3],o=1/N[4][3];ue(a<o);let n=a+Math.sqrt(a*o);const l=Math.sin(Xr(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));n/=l,wa(N,n,l,hr,cr,Ca,dr,ur),Ta(hr,cr,dr,ur,s.projectionMatrix),s.projectionMatrix[10]=2/(r-i),s.projectionMatrix[14]=-(r+i)/(r-i)}function Ra(e){let{near:t,far:r}=e;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}let L=class extends Zr{constructor(e){super(e),this._pending=new Oa,this._changes=new Cs,this._renderers=new Map,this._sortedRenderers=new xr,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._sortedRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materials(){return this.rendererContext.materials}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){for(const e of this._renderers.values())if(e.numGeometries!==0&&!e.queryRenderOccludedState(Te.Occlude))return!0;return!1}get isEmpty(){return!this.updating&&this._renderers.size===0&&this._geometries.size===0}getMaterialRenderer(e){return this._renderers.get(e)}get sortedRenderers(){return this._sortedRenderers}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=ws(this._changes);let t=!1;return e.forEach((r,i)=>{let s=this._renderers.get(i);!s&&r.adds.length>0&&(s=new Ts({material:i}),s.initializeRenderContext(this.rendererContext.pluginContext,this._materials),this._renderers.set(i,s),t=!0),s&&(s.modify(r),s.numGeometries===0&&(this._renderers.delete(i),s.destroy(),t=!0))}),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),this._hasHighlights=de(this._renderers,r=>{const i=r.produces.get(D.DRAPED_MATERIAL);return!!i&&i(O.Highlight)}),this._hasWater=de(this._renderers,r=>{const i=r.produces.get(D.DRAPED_WATER);return!!i&&i(O.Normal)}),this.notifyChange("updating"),!0}addGeometries(e,t){if(e.length===0)return;const r=this._validateRenderGeometries(e);for(const s of r)this._geometries.set(s.id,s);const i=this._pending.empty;for(const s of r)this._pending.adds.add(s);i&&this.notifyChange("updating"),t===jt.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const r=this._pending.empty,i=this._pending.adds;for(const s of e)i.has(s)?(this._pending.removed.add(s),i.delete(s)):this._pending.removed.has(s)||this._pending.removes.add(s),this._geometries.delete(s.id);r&&!this._pending.empty&&this.notifyChange("updating"),t===jt.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const r=this._changes.updates.length===0;for(const i of e){const s=this._changes.updates.pushNew();s.renderGeometry=this._validateRenderGeometry(i),s.updateType=t}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case dt.TRANSFORMATION:case dt.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case dt.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedRenderers.forAll(r=>t=!!r.updateAnimation&&r.updateAnimation(e)||t),t}precompile(e){return this._sortedRenderers.reduce((t,r)=>r.precompile(e)||t,!1)}render(e){this._sortedRenderers.forAll(t=>{const r=t.acquireTechniques(e);r&&(t.render(e,r),bs(r))})}intersect(e,t,r,i,s){for(const a of this._geometries.values()){if(!i(a))continue;this._intersectRenderGeometry(a,r,t,0,e,s);const o=this.rendererContext.longitudeCyclical;o&&(a.boundingSphere[0]-a.boundingSphere[3]<o.min&&this._intersectRenderGeometry(a,r,t,o.range,e,s),a.boundingSphere[0]+a.boundingSphere[3]>o.max&&this._intersectRenderGeometry(a,r,t,-o.range,e,s)),s++}return s}_updateSortedMaterialRenderers(){this._sortedRenderers.clear();let e=0;for(const t of this._renderers.values())t.drapedPriority=e++,this._sortedRenderers.push(t);this._sortedRenderers.sort((t,r)=>{var i,s,a,o;return((i=r.material)==null?void 0:i.renderPriority)===((s=t.material)==null?void 0:s.renderPriority)?t.drapedPriority-r.drapedPriority:(((a=r.material)==null?void 0:a.renderPriority)||0)-(((o=t.material)==null?void 0:o.renderPriority)||0)})}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes)),this._changes.updates.filterInPlace(({renderGeometry:e})=>!this._pending.has(e)),this._pending.clear()}_intersectRenderGeometry(e,t,r,i,s,a){if(!e.visible||!e.material.visible)return;let o=0;i+=e.transformation[12],o=e.transformation[13],mt[0]=r[0]-i,mt[1]=r[1]-o,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,s,mt,(n,l,h)=>{$a(t,h,a,e.material.renderPriority,s,e.layerUid,e.graphicUid)},t)}_notifyGraphicGeometryChanged(e){if(this.drapeSource.notifyGraphicGeometryChanged==null)return;let t;for(const{graphicUid:r}of e)r!=null&&r!==t&&(this.drapeSource.notifyGraphicGeometryChanged(r),t=r)}_notifyGraphicVisibilityChanged(e){if(this.drapeSource.notifyGraphicVisibilityChanged==null)return;let t;for(const{graphicUid:r}of e)r!=null&&r!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(r),t=r)}_validateRenderGeometries(e){for(const t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return e.localOrigin==null&&(e.localOrigin=this._localOriginFactory.getOrigin(br(e.boundingSphere))),e}get test(){}};d([m()],L.prototype,"drapeSource",void 0),d([m()],L.prototype,"updating",null),d([m()],L.prototype,"rctx",null),d([m({constructOnly:!0})],L.prototype,"rendererContext",void 0),d([m()],L.prototype,"_materials",null),d([m()],L.prototype,"_localOriginFactory",null),d([m({readOnly:!0})],L.prototype,"isEmpty",null),d([m()],L.prototype,"_renderers",void 0),d([m()],L.prototype,"_geometries",void 0),L=d([U("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],L);class Oa{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(t){return this.adds.has(t)||this.removes.has(t)||this.removed.has(t)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}function $a(e,t,r,i,s,a,o){const n=new qs(a,o,t),l=h=>{h.set(Hs.OVERLAY,n,e.dist,e.normal,e.transformation,r,i)};if((s.results.min.drapedLayerOrder==null||r>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&l(s.results.min),s.options.store!==Xt.MIN&&(s.results.max.drapedLayerOrder==null||r<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&l(s.results.max),s.options.store===Xt.ALL){const h=Ls(s.ray);l(h),s.results.all.push(h)}}const mt=x();let mr=class extends Le{constructor(t,r,i){super(t,r,new Ne(ea,()=>Ee(()=>import("./ImageMaterial.glsl-BgV2IVLt.js").then(s=>s.T),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177]))),i)}initializePipeline(t){return t.hasAlpha?Se({blending:Pr,colorWrite:De}):Se({colorWrite:De})}},Gr=class extends Si{constructor(){super(...arguments),this.hasAlpha=!1}};d([A()],Gr.prototype,"hasAlpha",void 0);let Wr=class extends st{constructor(){super(...arguments),this.overlayIndex=B.INNER,this.opacity=1}};function Sa(){const e=new Me;return e.include(Dt),e.fragment.uniforms.add(new we("tex",t=>t.texture)),e.fragment.uniforms.add(new $r("overlayIdx",t=>t.overlayIndex)),e.fragment.uniforms.add(new pe("opacity",t=>t.opacity)),e.fragment.main.add(R`vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;`),e}const Da=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:Wr,build:Sa},Symbol.toStringTag,{value:"Module"}));let fr=class extends Le{constructor(t,r,i){super(t,r,new Ne(Da,()=>Ee(()=>import("./ImageMaterial.glsl-BgV2IVLt.js").then(s=>s.O),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177]))),i)}},H=class extends Rs{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Wr,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new xr,this._passParameters=new Fr,this._materials=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new at,this.worldToPCSRatio=1,this.events=new Jr,this.longitudeCyclical=null,this.produces=new Map([[D.DRAPED_MATERIAL,t=>t!==O.Highlight||this.hasHighlights],[D.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const{view:e}=this,{_stage:t}=e,r=t.renderer.fboCache,i=t.renderView,{waterTextures:s,textures:a}=i;this._renderContext=new fa(this._rctx,new ya(r,e.state.viewingMode)),this.addHandles([ce(()=>s.updating,()=>this.events.emit("content-changed"),Ce),ce(()=>this.spatialReference,l=>this._localOriginFactory=new ms(l),Ce),Kr(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),ce(()=>Hr(this.view.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,Ce)]),this._materials=new ga(a,this._techniques,()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));const{_bindParameters:o,_camera:n}=this;o.slot=D.DRAPED_MATERIAL,o.mainDepth=null,n.near=1,n.far=1e4,n.relativeElevation=null,o.camera=this._camera,o.oitPass=Je.NONE,o.updateLighting([new Di(ei())],0,0,it.Immediate),this.addHandles(this.view.resourceController.scheduler.registerTask(Gs.STAGE,this))}destroy(){this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._passParameters.texture=Re(this._passParameters.texture),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this.view._stage.renderView.renderingContext}get _techniques(){return this.view._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){this._pluginContext=e,this._techniques.precompile(fr)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||de(this._renderers,e=>e.updating)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(e){for(const t of this._renderers.values()){const r=t.getMaterialRenderer(e);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map(e=>e.drapeSource.layer).filter(e=>!!e)}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,L)}createDrapeSourceRenderer(e,t,r){const i=this._renderers.get(e);i!=null&&i.destroy();const s=new t({...r,rendererContext:this,drapeSource:e});return this._renderers.set(e,s),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles(ce(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e),s}removeDrapeSourceRenderer(e){if(e==null)return;const t=this._renderers.get(e);t!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){var e;return((e=this._renderTargets)==null?void 0:e.computeValidity())??0}releaseRenderTargets(){var e;(e=this._renderTargets)==null||e.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&ot(e,t=>t.drapeTargetType===fs.WithoutRasterImage)}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=ot(e,t=>t.drapeSourceType===Ue.Features),this._hasDrapedRasterSource=ot(e,t=>t.drapeSourceType===Ue.RasterImage)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,r=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new Bs(this.view._stage.renderer.fboCache),this._overlays=[new Kt,new Kt]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=Re(this._renderTargets),this.events.emit("textures-disposed")}getTexture(e){var t,r;if(e!=null)return e===T.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?(t=this._renderTargets)==null?void 0:t.getTexture(T.Color):(r=this._renderTargets)==null?void 0:r.getTexture(e)}get running(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_processDrapeSources(e,t){let r=!1;for(const[i,s]of this._renderers){if(e.done)break;(i.destroyed||t(i))&&s.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=de(this._renderers,i=>i.hasHighlights),this.notifyChange("rendersOccludedDraped"),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(Ws,e=>e.updatePolicy===vs.SYNC)}get isEmpty(){return!ct.OVERLAY_DRAW_DEBUG_TEXTURE&&!de(this._renderers,e=>!e.isEmpty)}get hasWater(){return this._hasWater}get rendersOccludedDraped(){const e=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=ft,++this._techniques.precompiling;const t=this._sortedRenderers.some(({renderer:r})=>r.precompile(this._renderContext));return--this._techniques.precompiling,this._renderContext.renderOccludedMask=e,t}renders(e){if(ct.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==T.Occluded&&e!==T.Highlight)return!0;++this._techniques.precompiling;const t=this._sortedRenderers.some(({renderer:r})=>r.precompile(this._renderContext));return--this._techniques.precompiling,t}get mode(){var e,t;return this.isEmpty?ge.Disabled:(e=this._renderTargets)!=null&&e.getTexture(T.WaterNormal)?ge.EnabledWithWater:(t=this._renderTargets)!=null&&t.getTexture(T.Color)?ge.Enabled:ge.Disabled}updateAnimation(e){let t=!1;return this._renderers.forEach(r=>t=r.updateAnimation(e)||t),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(this._renderTargets){this._bindParameters.alignPixelEnabled=e.alignPixelEnabled,this._bindParameters.highlightGroupName=null,++this._techniques.precompiling;for(const t of this._renderTargets.targets){if(t.content===T.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const r=t.output;this._renderContext.output=r,this._bindParameters.slot=r===O.Normal?D.DRAPED_WATER:D.DRAPED_MATERIAL,t.content===T.Occluded&&(this._renderContext.renderOccludedMask=ft),this._sortedRenderers.forAll(({drapeSource:i,renderer:s})=>{t.content===T.ColorNoRasterImage&&i.drapeSourceType===Ue.RasterImage||s.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=Ze}--this._techniques.precompiling}}drawOverlays(e){if(this._overlays&&this._renderTargets){for(const t of this._overlays)this.longitudeCyclical?t.setupGeometryViewsCyclical(this.longitudeCyclical):t.setupGeometryView();this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;for(const t of this._renderTargets.targets){if(t.content===T.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const r=this._drawTarget(B.INNER,t,e),i=this._drawTarget(B.OUTER,t,e);(r||i)&&t.fbo.generateMipMap()}}}_drawTarget(e,t,r){const i=this._overlays[e],s=i.canvasGeometries;if(s.numViews===0)return!1;const{contentPixelRatio:a}=r;this._screenToWorldRatio=a*i.mapUnitsPerPixel/this._bindParameters.overlayStretch;const o=t.output;if(this.isEmpty||o===O.Normal&&!this.hasWater||!i.hasSomeSizedView())return!1;const{_rctx:n,_bindParameters:l}=this;if(this._camera.pixelRatio=i.pixelRatio*a,this._renderContext.output=o,l.screenToWorldRatio=this._screenToWorldRatio,l.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,l.slot=o===O.Normal?D.DRAPED_WATER:D.DRAPED_MATERIAL,t.content===T.Occluded&&(this._renderContext.renderOccludedMask=ft),l.highlightGroupName=null,!this.renders(t.content))return this._renderContext.renderOccludedMask=Ze,!1;const{resolution:h}=i,u=e===B.INNER?0:h;if(n.setViewport(u,0,h,h),this._bindTargetFBO(t),e===B.INNER&&(n.setClearColor(0,0,0,0),n.clear($e.COLOR)),ct.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==T.Occluded&&t.content!==T.Highlight){this._techniques.precompile(mr,Ot);const g=this._techniques.acquire(mr,Ot);for(let f=0;f<s.numViews;f++)this._setViewParameters(s.extents[f],i),this._ensureDebugPatternResources(i.resolution,Aa[e]),n.bindTechnique(g,l,this._passParameters),n.screen.draw();g.release()}if(t.output===O.Highlight){const{fboCache:g}=this.view._stage.renderer,f=this._resolution;ua(n,g,{width:f,height:f},this.view.highlights,l,()=>this._renderAllGeometry(e,t),u,()=>this._bindTargetFBO(t))}else this._renderAllGeometry(e,t);return n.bindFramebuffer(null),this._renderContext.renderOccludedMask=Ze,!0}_renderAllGeometry(e,t){const r=this._overlays[e],i=r.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:s,renderer:a})=>{if(t.content===T.ColorNoRasterImage&&s.drapeSourceType===Ue.RasterImage)return;const{fullOpacity:o}=s,n=o!=null&&o<1&&t.output===O.Color&&this._bindTemporaryFBO();for(let l=0;l<i.numViews;l++)this._setViewParameters(i.extents[l],r),a.render(this._renderContext);if(n){this._bindTargetFBO(t),this._overlayParameters.texture=n.getTexture(),this._overlayParameters.opacity=o,this._overlayParameters.overlayIndex=e;const l=this._techniques.acquire(fr);this._rctx.bindTechnique(l,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),l.release(),n.release()}})}_bindTargetFBO(e){const t=this._resolution,r=2*t;e.fbo.bind(this._rctx,r,t)}_bindTemporaryFBO(){const e=this._resolution,t=2*e,r=this.view._stage.renderer.fboCache,i=r.acquire(t,e,"overlay tmp");return r.rctx.bindFramebuffer(i.fbo),r.rctx.clear($e.COLOR),i}get _resolution(){var e;return((e=this._overlays)==null?void 0:e[B.INNER].resolution)??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,r,i){var a;this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let s=0;for(const{renderer:o}of this._sortedRenderers)s=((a=o.intersect)==null?void 0:a.call(o,e,t,r,i,s))??s}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const e=this.view.map.allLayers,t=e.length;this._renderers.forEach((r,i)=>{const s=e.indexOf(i.layer),a=s>=0,o=i.renderGroup??(a?zt.MapLayer:zt.ViewLayer),n=t*o+(a?s:0);this._sortedRenderers.push(new Pa(i,r,n))}),this._sortedRenderers.sort((r,i)=>r.index-i.index)}_setViewParameters(e,t){const r=this._camera;r.viewport=[0,0,t.resolution,t.resolution],ti(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),ri(r.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=de(this._renderers,t=>t.hasWater);e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water"))}_ensureDebugPatternResources(e,t){if(Tr(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const r=new Uint8Array(e*e*4);let i=0;for(let a=0;a<e;a++)for(let o=0;o<e;o++){const n=Math.floor(o/10),l=Math.floor(a/10);n<2||l<2||10*n>e-20||10*l>e-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&n&&1&l?1&o^1&a?0:255:1&n^1&l?0:128)}const s=new Er(e);s.samplingMode=Sr.NEAREST,this._passParameters.texture=new tt(this._rctx,s,r)}get test(){}};d([m()],H.prototype,"hasHighlights",void 0),d([m()],H.prototype,"_sortedDrapeSourceRenderersDirty",void 0),d([m({constructOnly:!0})],H.prototype,"view",void 0),d([m({readOnly:!0})],H.prototype,"_techniques",null),d([m()],H.prototype,"worldToPCSRatio",void 0),d([m()],H.prototype,"spatialReference",void 0),d([m({type:Boolean,readOnly:!0})],H.prototype,"updating",null),d([m()],H.prototype,"isEmpty",null),d([m({readOnly:!0})],H.prototype,"rendersOccludedDraped",null),H=d([U("esri.views.3d.terrain.OverlayRenderer")],H);class Pa{constructor(t,r,i){this.drapeSource=t,this.renderer=r,this.index=i}}const Aa=[[1,.5,.5],[.5,.5,1]],Ia=-2,ft=Te.OccludeAndTransparent,Ot=new Gr;Ot.hasAlpha=!0;let un=class{constructor(t,r={}){this.geometry=t,this.screenToWorldRatio=1,this._transformation=G(),this._shaderTransformation=null,this._boundingSphere=null,this.id=ii(),this.layerUid=r.layerUid,this.graphicUid=r.graphicUid,this.castShadow=r.castShadow??!1,r.objectShaderTransformation&&this.objectShaderTransformationChanged(r.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(t){si(this._transformation,t),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(t){t==null?this._shaderTransformation=null:(this._shaderTransformation??(this._shaderTransformation=G()),vt(this._shaderTransformation,t,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??(this._boundingSphere=gi()),wr(br(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*_i(this.shaderTransformation)),this._boundingSphere):pi}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get highlight(){return this.geometry.highlights}foreachHighlightGroup(t){this.geometry.foreachHighlightGroup(t)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(t){this.geometry.visible=t}};class Ea extends Pi{intersect(t,r,i,s,a,o){return Ai(t,i,s,a,void 0,o)}}function Fa(e){const t=new Me,{vertex:r,fragment:i,attributes:s,varyings:a}=t;Ii(r,e),t.include(Ei,e),t.include(Fi,e),t.include(Mi,e),t.include(Li,e),t.include(Wt,e),t.include(Ni,e),s.add(y.POSITION,"vec3"),e.vvColor&&s.add(y.COLORFEATUREATTRIBUTE,"float"),a.add("vColor","vec4"),a.add("vpos","vec3");const o=e.terrainDepthTest&&e.output===O.Color;return o&&a.add("depth","float"),r.uniforms.add(new Hi("eColor",n=>n.color)),r.main.add(R`
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();

      ${e.hasVertexColors?"vColor *= eColor;":e.vvColor?"vColor = eColor * interpolateVVColor(colorFeatureAttribute);":"vColor = eColor;"}
      ${o?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = transformPosition(proj, view, vpos);`),t.include(Wt,e),o&&t.include(Gi,e),i.include(Wi),i.main.add(R`
    discardBySlice(vpos);
    ${o?"terrainDepthTest(depth);":""}
    vec4 fColor = vColor;
    outputColorHighlightOID(fColor, vpos);`),t}const Ma=Object.freeze(Object.defineProperty({__proto__:null,build:Fa},Symbol.toStringTag,{value:"Module"}));class La extends Le{constructor(t,r,i){super(t,r,new Ne(Ma,()=>Ee(()=>import("./ImageMaterial.glsl-BgV2IVLt.js").then(s=>s.C),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177]))),i)}_createPipeline(t,r){const{oitPass:i,output:s,transparent:a,cullFace:o,draped:n,hasOccludees:l,polygonOffset:h,enableOffset:u}=t,g=i===Je.NONE,f=i===Je.FrontFace;return Se({blending:s===O.Color&&a?Ui(i):null,culling:ns(o),depthTest:n?null:{func:Vi(i)},depthWrite:qi(t),drawBuffers:s===O.Depth?{buffers:[os.NONE]}:zi(i,s),colorWrite:De,stencilWrite:l?ji:null,stencilTest:l?r?Bi:ki:null,polygonOffset:g||f?h?Na:null:Yi(u)})}initializePipeline(t){return this._occludeePipelineState=this._createPipeline(t,!0),this._createPipeline(t,!1)}getPipeline(t){return t?this._occludeePipelineState:super.getPipeline()}}const Na={factor:1,units:1};let I=class extends Qi{constructor(){super(...arguments),this.cullFace=Pt.None,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.discardInvisibleFragments=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.objectAndLayerIdColorInstanced=!1,this.vvColor=!1,this.draped=!1,this.textureCoordinateType=Xi.None,this.emissionSource=Zi.None,this.occlusionPass=!1,this.hasVvInstancing=!0,this.vvSize=!1,this.vvOpacity=!1}};d([A({count:Pt.COUNT})],I.prototype,"cullFace",void 0),d([A()],I.prototype,"hasSlicePlane",void 0),d([A()],I.prototype,"hasVertexColors",void 0),d([A()],I.prototype,"transparent",void 0),d([A()],I.prototype,"discardInvisibleFragments",void 0),d([A()],I.prototype,"polygonOffset",void 0),d([A()],I.prototype,"enableOffset",void 0),d([A()],I.prototype,"writeDepth",void 0),d([A()],I.prototype,"hasOccludees",void 0),d([A()],I.prototype,"terrainDepthTest",void 0),d([A()],I.prototype,"cullAboveTerrain",void 0),d([A()],I.prototype,"objectAndLayerIdColorInstanced",void 0),d([A()],I.prototype,"vvColor",void 0),d([A()],I.prototype,"draped",void 0);let _n=class extends Ea{constructor(t){super(t,Ga),this._configuration=new I,this.supportsEdges=!0,this.produces=new Map([[D.OPAQUE_MATERIAL,r=>this._isOpaqueMaterialPass(r)],[D.OPAQUE_MATERIAL_WITHOUT_NORMALS,r=>this._isOpaqueNoSSAODepthPass(r)],[D.TRANSPARENT_MATERIAL,r=>nt(r)&&this._transparent&&this.parameters.writeDepth],[D.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,r=>Lt(r)&&this._transparent&&this.parameters.writeDepth],[D.TRANSPARENT_MATERIAL_WITHOUT_DEPTH,r=>nt(r)&&this._transparent&&!this.parameters.writeDepth],[D.DRAPED_MATERIAL,r=>fi(r)]])}getConfiguration(t,r){return this._configuration.output=t,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._transparent,this._configuration.discardInvisibleFragments=this._transparent&&!this._isOpaquePass(t)&&this.parameters.discardInvisibleFragments,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=r.hasOccludees,this._configuration.oitPass=r.oitPass,this._configuration.enableOffset=r.camera.relativeElevation<Ji,this._configuration.terrainDepthTest=r.terrainDepthTest,this._configuration.cullAboveTerrain=r.cullAboveTerrain,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}get visible(){return this.parameters.color[3]>=vi}get _transparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}_isOpaquePass(t){return this._isOpaqueMaterialPass(t)||this._isOpaqueNoSSAODepthPass(t)}_isOpaqueMaterialPass(t){return t===O.Highlight||nt(t)&&!this._transparent}_isOpaqueNoSSAODepthPass(t){return Lt(t)&&this.parameters.writeDepth&&!this._transparent}createGLMaterial(t){return new Ha(t)}createBufferWriter(){const t=Fe().vec3f(y.POSITION);return Or()&&t.vec4u8(y.OBJECTANDLAYERIDCOLOR),this.parameters.vvColor?t.f32(y.COLORFEATUREATTRIBUTE):t.vec4u8(y.COLOR),new Ki(t)}},Ha=class extends es{beginSlot(t){return this.acquireTechnique(La,t)}},Ga=class extends ts{constructor(){super(...arguments),this.color=Rr,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Pt.None,this.draped=!1,this.discardInvisibleFragments=!1}};const yn=Fe().vec3f(y.POSITION),xn=Fe().vec3f(y.POSITION).vec2f(y.UV0),Cn=Fe().vec3f(y.POSITION).vec4u8(y.COLOR),wn=Fe().vec3f(y.POSITION).vec2f(y.UV0).vec4u8(y.OBJECTANDLAYERIDCOLOR);function Tn(e,t,r=null){const i=[],s=t.mapPositions;Wa(t,i);const a=i[0][1].data,o=i[0][1].indices.length,n=ps(o);return Ua(t,i,n),za(t,i,n),Va(t,i,n),qa(t,i,n),ja(t,i,n),Ba(t,i,n),ka(t,i,a),new rs(e,i,s,is.Line,r)}function Wa(e,t){const{attributeData:{position:r},removeDuplicateStartEnd:i}=e,s=Ya(r)&&i,a=r.length/3-(s?1:0),o=new Array(2*(a-1)),n=s?r.slice(0,-3):r;let l=0;for(let h=0;h<a-1;h++)o[l++]=h,o[l++]=h+1;t.push([y.POSITION,new Y(n,o,3,s)])}function Ua(e,t,r){if(e.attributeData.colorFeature!=null)return;const i=e.attributeData.color;t.push([y.COLOR,new Y(i??mi,r,4)])}function Va(e,t,r){e.attributeData.normal&&t.push([y.NORMAL,new Y(e.attributeData.normal,r,3)])}function qa(e,t,r){e.attributeData.colorFeature!=null&&t.push([y.COLORFEATUREATTRIBUTE,new Y([e.attributeData.colorFeature],r,1,!0)])}function za(e,t,r){e.attributeData.sizeFeature==null&&t.push([y.SIZE,new Y([e.attributeData.size??1],r,1,!0)])}function ja(e,t,r){e.attributeData.sizeFeature!=null&&t.push([y.SIZEFEATUREATTRIBUTE,new Y([e.attributeData.sizeFeature],r,1,!0)])}function Ba(e,t,r){e.attributeData.opacityFeature!=null&&t.push([y.OPACITYFEATUREATTRIBUTE,new Y([e.attributeData.opacityFeature],r,1,!0)])}function ka(e,t,r){if(e.overlayInfo==null||e.overlayInfo.renderCoordsHelper.viewingMode!==Ar.Global||!e.overlayInfo.spatialReference.isGeographic)return;const i=Cr(r.length),s=ai(e.overlayInfo.spatialReference);for(let g=0;g<i.length;g+=3)us(r,g,i,g,s);const a=r.length/3,o=ss(a+1);let n=Qa,l=Xa,h=0,u=0;_e(n,i[u++],i[u++]),u++,o[0]=0;for(let g=1;g<a+1;++g)g===a&&(u=0),_e(l,i[u++],i[u++]),u++,h+=cs(n,l),o[g]=h,[n,l]=[l,n];t.push([y.DISTANCETOSTART,new Y(o,t[0][1].indices,1,!0)])}function Ya(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}const Qa=x(),Xa=x(),$={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},Za={dash:$.dash,"dash-dot":[...$.dash,...$.dot],dot:$.dot,"long-dash":$["long-dash"],"long-dash-dot":[...$["long-dash"],...$.dot],"long-dash-dot-dot":[...$["long-dash"],...$.dot,...$.dot],none:null,"short-dash":$["short-dash"],"short-dash-dot":[...$["short-dash"],...$["short-dot"]],"short-dash-dot-dot":[...$["short-dash"],...$["short-dot"],...$["short-dot"]],"short-dot":$["short-dot"],solid:null},Ja=8;function Ka(e,t){return e==null?e:{pattern:e.slice(),pixelRatio:t}}function bn(e){return{pattern:[e,e],pixelRatio:2}}function Rn(e){return(e==null?void 0:e.type)==="style"?eo(e.style):null}function eo(e){return e!=null?Ka(Za[e],Ja):null}function On(e,t,r,i){const s=e.type==="polygon"?Ke.CCW_IS_HOLE:Ke.NONE,a=e.type==="polygon"?e.rings:e.paths,{position:o,outlines:n}=Ir(a,!!e.hasZ,s,e.spatialReference),l=Cr(o.length),h=ys(o,e.spatialReference,0,l,0,o,0,o.length/3,t,r,i),u=h!=null;return{lines:u?Ur(n,o,l):[],projectionSuccess:u,sampledElevation:h}}function $n(e,t){const r=e.type==="polygon"?Ke.CCW_IS_HOLE:Ke.NONE,i=e.type==="polygon"?e.rings:e.paths,{position:s,outlines:a}=Ir(i,!1,r),o=gs(s,e.spatialReference,0,s,t,0);for(let n=2;n<s.length;n+=3)s[n]=Ia;return{lines:o?Ur(a,s):[],projectionSuccess:o}}function Ur(e,t,r=null){const i=new Array;for(const{index:s,count:a}of e){if(a<=1)continue;const o=3*s,n=3*a;i.push({position:Ft(t,3*s,3*a),mapPositions:r!=null?Ft(r,o,n):void 0})}return i}var vr;(function(e){e[e.EnableFastUpdates=0]="EnableFastUpdates",e[e.DisableFastUpdates=1]="DisableFastUpdates",e[e.UpdateFastLocalOrigin=2]="UpdateFastLocalOrigin"})(vr||(vr={}));export{wn as I,_n as O,Cn as a,Tn as b,vr as c,bn as d,Ea as e,xn as f,un as g,Qo as h,sa as i,ta as j,J as k,$n as l,Lr as m,Rn as n,Mr as o,On as p,Fr as q,Ia as r,Ks as s,yn as t,ra as u,Wr as v,Sa as w,Fa as x};
