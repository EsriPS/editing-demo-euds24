const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/loader-rFm1OQwB.js","assets/index-C1aGfQcb.js","assets/index-qkyhuh7d.css","assets/mat4f64-Dk4dwAN8.js","assets/enums-Dk3osxpS.js","assets/Version-DD-eRUXC.js","assets/quat-D8-cBF-l.js","assets/mat3f64-q3fE-ZOt.js","assets/quatf64-aQ5IuZRd.js","assets/vec32-CmwgPQMd.js","assets/vec42-BHDxGccW.js","assets/BufferView-sBvw8vqP.js","assets/vec2-D9okOEat.js","assets/resourceUtils-B_8TRwJ-.js","assets/basicInterfaces-CZwQPxTp.js"])))=>i.map(i=>d[i]);
import{hQ as ye,aQ as oe,aR as be,aH as ae,aO as we,cU as J,dJ as ie,hO as N,aA as ve,aE as Te,g0 as K,cY as $e,cr as G}from"./index-C1aGfQcb.js";import{a as Re}from"./webStyleSymbolUtils-kO7zmqzd.js";import{i as Y,j as Ae,n as Me}from"./mat3-Dg2BrR6m.js";import{t as z,e as ue}from"./mat3f64-q3fE-ZOt.js";import{e as Be}from"./mat4f64-Dk4dwAN8.js";import{l as Ee}from"./vec2f64-CCfZVA9N.js";import{E as X,c as Oe,i as Z,r as Se,A as Ie,I as Pe}from"./vec32-CmwgPQMd.js";import{C as le,p as ce,t as L}from"./Texture-D7jaxJ9P.js";import{c as Ce,x as me,L as Fe,i as fe,O as Ue,E as _e}from"./BufferView-sBvw8vqP.js";import{e as ke,f as Le,l as ee,o as te}from"./vec3-C734WYsa.js";import{n as Ne,s as re}from"./vec4-qgGorNMJ.js";import{n as je,o as P,a as qe,b as De,t as Ve,c as Ge}from"./DefaultMaterial_COLOR_GAMMA-C-Gr0Vk1.js";import{r as H}from"./resourceUtils-B_8TRwJ-.js";import{i as ze,f as He}from"./vec2f32-BbH2jxlN.js";import{t as Qe}from"./NestedMap-GuqgquCN.js";import{r as de}from"./Version-DD-eRUXC.js";import{l as We}from"./Indices-NXfq_dEG.js";import{t as Je}from"./requestImageUtils-C-ZsPy5-.js";import{t as F}from"./orientedBoundingBox-DCXdMZSx.js";import{e as Q,i as R,n as Ke}from"./basicInterfaces-CZwQPxTp.js";import{e as I}from"./VertexAttribute-Cq4MnHjR.js";import{B as j,s as Ye,t as Xe,n as Ze,o as et}from"./DefaultMaterial-DLGx92FQ.js";import{D as se}from"./enums-Dk3osxpS.js";import{a as ne}from"./NormalAttribute.glsl-DGUKFRgB.js";const B=()=>ve.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function tt(r,t){const n=await rt(r,t),s=await it(n.textureDefinitions??{},t);let l=0;for(const i in s)if(s.hasOwnProperty(i)){const o=s[i];l+=o!=null&&o.image?o.image.width*o.image.height*4:0}return{resource:n,textures:s,size:l+ye(n)}}async function rt(r,t){const n=t==null?void 0:t.streamDataRequester;if(n)return st(r,n,t);const s=await oe(be(r,t));if(s.ok===!0)return s.value.data;ae(s.error),pe(s.error)}async function st(r,t,n){const s=await oe(t.request(r,"json",n));if(s.ok===!0)return s.value;ae(s.error),pe(s.error.details.url)}function pe(r){throw new we("",`Request for object resource failed: ${r}`)}function nt(r){const t=r.params,n=t.topology;let s=!0;switch(t.vertexAttributes||(B().warn("Geometry must specify vertex attributes"),s=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const i=t.faces;if(i){if(t.vertexAttributes)for(const o in t.vertexAttributes){const u=i[o];u!=null&&u.values?(u.valueType!=null&&u.valueType!=="UInt32"&&(B().warn(`Unsupported indexed geometry indices type '${u.valueType}', only UInt32 is currently supported`),s=!1),u.valuesPerElement!=null&&u.valuesPerElement!==1&&(B().warn(`Unsupported indexed geometry values per element '${u.valuesPerElement}', only 1 is currently supported`),s=!1)):(B().warn(`Indexed geometry does not specify face indices for '${o}' attribute`),s=!1)}}else B().warn("Indexed geometries must specify faces"),s=!1;break}default:B().warn(`Unsupported topology '${n}'`),s=!1}r.params.material||(B().warn("Geometry requires material"),s=!1);const l=r.params.vertexAttributes;for(const i in l)l[i].values||(B().warn("Geometries with externally defined attributes are not yet supported"),s=!1);return s}function ot(r,t){var x,b;const n=new Array,s=new Array,l=new Array,i=new Qe,o=r.resource,u=de.parse(o.version||"1.0","wosr");lt.validate(u);const c=o.model.name,e=o.model.geometries,a=o.materialDefinitions??{},m=r.textures;let f=0;const p=new Map;for(let d=0;d<e.length;d++){const h=e[d];if(!nt(h))continue;const T=ut(h),w=h.params.vertexAttributes,U=[],q=g=>{if(h.params.topology==="PerAttributeArray")return null;const $=h.params.faces;for(const M in $)if(M===g)return $[M].values;return null},O=w[I.POSITION],k=O.values.length/O.valuesPerElement;for(const g in w){const $=w[g],M=$.values,V=q(g)??We(k);U.push([g,new F(M,V,$.valuesPerElement,!0)])}const A=T.texture,y=m&&m[A];if(y&&!p.has(A)){const{image:g,parameters:$}=y,M=new le(g,$);s.push(M),p.set(A,M)}const S=p.get(A),D=S?S.id:void 0,E=T.material;let v=i.get(E,A);if(v==null){const g=a[E.slice(E.lastIndexOf("/")+1)].params;g.transparency===1&&(g.transparency=0);const $=y&&y.alphaChannelUsage,M=g.transparency>0||$==="transparency"||$==="maskAndTransparency",V=y?xe(y.alphaChannelUsage):void 0,W={ambient:J(g.diffuse),diffuse:J(g.diffuse),opacity:1-(g.transparency||0),transparent:M,textureAlphaMode:V,textureAlphaCutoff:.33,textureId:D,initTextureTransparent:!0,doubleSided:!0,cullFace:Q.None,colorMixMode:g.externalColorMixMode||"tint",textureAlphaPremultiplied:(y==null?void 0:y.parameters.preMultiplyAlpha)??!1};t!=null&&t.materialParameters&&Object.assign(W,t.materialParameters),v=new j(W,t),i.set(E,A,v)}l.push(v);const ge=new ce(v,U);f+=((b=(x=U.find(g=>g[0]===I.POSITION))==null?void 0:x[1])==null?void 0:b.indices.length)??0,n.push(ge)}return{engineResources:[{name:c,stageResources:{textures:s,materials:l,geometries:n},pivotOffset:o.model.pivotOffset,numberOfVertices:f,lodThreshold:null}],referenceBoundingBox:at(n)}}function at(r){const t=ie();return r.forEach(n=>{const s=n.boundingInfo;s!=null&&(N(t,s.bbMin),N(t,s.bbMax))}),t}async function it(r,t){const n=new Array;for(const i in r){const o=r[i],u=o.images[0].data;if(!u){B().warn("Externally referenced texture data is not yet supported");continue}const c=o.encoding+";base64,"+u,e="/textureDefinitions/"+i,a=o.channels==="rgba"?o.alphaChannelUsage||"transparency":"none",m={noUnpackFlip:!0,wrap:{s:se.REPEAT,t:se.REPEAT},preMultiplyAlpha:xe(a)!==R.Opaque},f=t!=null&&t.disableTextures?Promise.resolve(null):Je(c,t);n.push(f.then(p=>({refId:e,image:p,parameters:m,alphaChannelUsage:a})))}const s=await Promise.all(n),l={};for(const i of s)l[i.refId]=i;return l}function xe(r){switch(r){case"mask":return R.Mask;case"maskAndTransparency":return R.MaskBlend;case"none":return R.Opaque;default:return R.Blend}}function ut(r){const t=r.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const lt=new de(1,2,"wosr");function _(r){if(r==null)return null;const t=r.offset!=null?r.offset:ze,n=r.rotation!=null?r.rotation:0,s=r.scale!=null?r.scale:He,l=z(1,0,0,0,1,0,t[0],t[1],1),i=z(Math.cos(n),-Math.sin(n),0,Math.sin(n),Math.cos(n),0,0,0,1),o=z(s[0],0,0,0,s[1],0,0,0,1),u=ue();return Y(u,i,o),Y(u,l,u),u}class ct{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class mt{constructor(t,n,s){this.name=t,this.lodThreshold=n,this.pivotOffset=s,this.stageResources=new ct,this.numberOfVertices=0}}async function ft(r,t){var m;const n=he(Re(r));if(n.fileType==="wosr"){const f=await(t.cache?t.cache.loadWOSR(n.url,t):tt(n.url,t)),{engineResources:p,referenceBoundingBox:x}=ot(f,t);return{lods:p,referenceBoundingBox:x,isEsriSymbolResource:!1,isWosr:!0}}let s;if(t.cache)s=await t.cache.loadGLTF(n.url,t,!!t.usePBR);else{const{loadGLTF:f}=await Te(()=>import("./loader-rFm1OQwB.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]));s=await f(new je(t.streamDataRequester),n.url,t,t.usePBR)}const l=(m=s.model.meta)==null?void 0:m.ESRI_proxyEllipsoid,i=s.meta.isEsriSymbolResource&&l!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";i&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,gt(s,l));const o=!!t.usePBR,u=s.meta.isEsriSymbolResource?{usePBR:o,isSchematic:!1,treeRendering:i,mrrFactors:Ye}:{usePBR:o,isSchematic:!1,treeRendering:!1,mrrFactors:Xe},c={...t.materialParameters,treeRendering:i},{engineResources:e,referenceBoundingBox:a}=dt(s,u,c,t,n.specifiedLodIndex);return{lods:e,referenceBoundingBox:a,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function he(r){const t=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:t[4]!=null?Number(t[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function dt(r,t,n,s,l){const i=r.model,o=new Array,u=new Map,c=new Map,e=i.lods.length,a=ie();return i.lods.forEach((m,f)=>{const p=s.skipHighLods===!0&&(e>1&&f===0||e>3&&f===1)||s.skipHighLods===!1&&l!=null&&f!==l;if(p&&f!==0)return;const x=new mt(m.name,m.lodThreshold,[0,0,0]);m.parts.forEach(b=>{const d=p?new j({},s):pt(i,b,x,t,n,u,c,s),{geometry:h,vertexCount:T}=xt(b,d??new j({},s)),w=h.boundingInfo;w!=null&&f===0&&(N(a,w.bbMin),N(a,w.bbMax)),d!=null&&(x.stageResources.geometries.push(h),x.numberOfVertices+=T)}),p||o.push(x)}),{engineResources:o,referenceBoundingBox:a}}function pt(r,t,n,s,l,i,o,u){var x,b;const c=t.material+(t.attributes.normal?"_normal":"")+(t.attributes.color?"_color":"")+(t.attributes.texCoord0?"_texCoord0":"")+(t.attributes.tangent?"_tangent":""),e=r.materials.get(t.material),a=t.attributes.texCoord0!=null,m=t.attributes.normal!=null;if(e==null)return null;const f=ht(e.alphaMode);if(!i.has(c)){if(a){const y=(S,D=!1)=>{if(S!=null&&!o.has(S)){const E=r.textures.get(S);if(E!=null){const v=E.data;o.set(S,new le(H(v)?v.data:v,{...E.parameters,preMultiplyAlpha:!H(v)&&D,encoding:H(v)&&v.encoding!=null?v.encoding:void 0}))}}};y(e.textureColor,f!==R.Opaque),y(e.textureNormal),y(e.textureOcclusion),y(e.textureEmissive),y(e.textureMetallicRoughness)}const d=e.color[0]**(1/P),h=e.color[1]**(1/P),T=e.color[2]**(1/P),w=e.emissiveFactor[0]**(1/P),U=e.emissiveFactor[1]**(1/P),q=e.emissiveFactor[2]**(1/P),O=e.textureColor!=null&&a?o.get(e.textureColor):null,k=Ze({normalTexture:e.textureNormal,metallicRoughnessTexture:e.textureMetallicRoughness,metallicFactor:e.metallicFactor,roughnessFactor:e.roughnessFactor,emissiveTexture:e.textureEmissive,emissiveFactor:e.emissiveFactor,occlusionTexture:e.textureOcclusion}),A=((x=e.normalTextureTransform)==null?void 0:x.scale)!=null?(b=e.normalTextureTransform)==null?void 0:b.scale:Ee;i.set(c,new j({...s,transparent:f===R.Blend,customDepthTest:Ke.Lequal,textureAlphaMode:f,textureAlphaCutoff:e.alphaCutoff,diffuse:[d,h,T],ambient:[d,h,T],opacity:e.opacity,doubleSided:e.doubleSided,doubleSidedType:"winding-order",cullFace:e.doubleSided?Q.None:Q.Back,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:m?ne.Attribute:ne.ScreenDerivative,castShadows:!0,receiveShadows:e.receiveShadows,receiveAmbientOcclusion:e.receiveAmbientOcclustion,textureId:O!=null?O.id:void 0,colorMixMode:e.colorMixMode,normalTextureId:e.textureNormal!=null&&a?o.get(e.textureNormal).id:void 0,textureAlphaPremultiplied:O!=null&&!!O.parameters.preMultiplyAlpha,occlusionTextureId:e.textureOcclusion!=null&&a?o.get(e.textureOcclusion).id:void 0,emissiveTextureId:e.textureEmissive!=null&&a?o.get(e.textureEmissive).id:void 0,metallicRoughnessTextureId:e.textureMetallicRoughness!=null&&a?o.get(e.textureMetallicRoughness).id:void 0,emissiveFactor:[w,U,q],mrrFactors:k?et:[e.metallicFactor,e.roughnessFactor,s.mrrFactors[2]],isSchematic:k,colorTextureTransformMatrix:_(e.colorTextureTransform),normalTextureTransformMatrix:_(e.normalTextureTransform),scale:[A[0],A[1]],occlusionTextureTransformMatrix:_(e.occlusionTextureTransform),emissiveTextureTransformMatrix:_(e.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:_(e.metallicRoughnessTextureTransform),...l},u))}const p=i.get(c);if(n.stageResources.materials.push(p),a){const d=h=>{h!=null&&n.stageResources.textures.push(o.get(h))};d(e.textureColor),d(e.textureNormal),d(e.textureOcclusion),d(e.textureEmissive),d(e.textureMetallicRoughness)}return p}function xt(r,t){const n=r.attributes.position.count,s=qe(r.indices||n,r.primitiveType),l=L(3*n),{typedBuffer:i,typedBufferStride:o}=r.attributes.position;ke(l,i,r.transform,3,o);const u=[[I.POSITION,new F(l,s,3,!0)]];if(r.attributes.normal!=null){const e=L(3*n),{typedBuffer:a,typedBufferStride:m}=r.attributes.normal;Ae(C,r.transform),Le(e,a,C,3,m),K(C)&&ee(e,e),u.push([I.NORMAL,new F(e,s,3,!0)])}if(r.attributes.tangent!=null){const e=L(4*n),{typedBuffer:a,typedBufferStride:m}=r.attributes.tangent;Me(C,r.transform),Ne(e,a,C,4,m),K(C)&&ee(e,e,4),u.push([I.TANGENT,new F(e,s,4,!0)])}if(r.attributes.texCoord0!=null){const e=L(2*n),{typedBuffer:a,typedBufferStride:m}=r.attributes.texCoord0;De(e,a,2,m),u.push([I.UV0,new F(e,s,2,!0)])}const c=r.attributes.color;if(c!=null){const e=new Uint8Array(4*n);c.elementCount===4?c instanceof Ce?re(e,c,255):c instanceof me?Ve(e,c):c instanceof Fe&&re(e,c,1/256):(e.fill(255),c instanceof fe?te(e,c.typedBuffer,255,4,c.typedBufferStride):r.attributes.color instanceof Ue?Ge(e,c.typedBuffer,4,r.attributes.color.typedBufferStride):r.attributes.color instanceof _e&&te(e,c.typedBuffer,1/256,4,c.typedBufferStride)),u.push([I.COLOR,new F(e,s,4,!0)])}return{geometry:new ce(t,u),vertexCount:n}}const C=ue();function ht(r){switch(r){case"BLEND":return R.Blend;case"MASK":return R.Mask;case"OPAQUE":case null:case void 0:return R.Opaque}}function gt(r,t){for(let n=0;n<r.model.lods.length;++n){const s=r.model.lods[n];for(const l of s.parts){const i=l.attributes.normal;if(i==null)return;const o=l.attributes.position,u=o.count,c=G(),e=G(),a=G(),m=new Uint8Array(4*u),f=new Float64Array(3*u),p=$e(Be(),l.transform);let x=0,b=0;for(let d=0;d<u;d++){o.getVec(d,e),i.getVec(d,c),X(e,e,l.transform),Oe(a,e,t.center),Z(a,a,t.radius);const h=a[2],T=Se(a),w=Math.min(.45+.55*T*T,1);Z(a,a,t.radius),p!==null&&X(a,a,p),Ie(a,a),n+1!==r.model.lods.length&&r.model.lods.length>1&&Pe(a,a,c,h>-1?.2:Math.min(-4*h-3.8,1)),f[x]=a[0],f[x+1]=a[1],f[x+2]=a[2],x+=3,m[b]=255*w,m[b+1]=255*w,m[b+2]=255*w,m[b+3]=255,b+=4}l.attributes.normal=new fe(f),l.attributes.color=new me(m)}}}const Dt=Object.freeze(Object.defineProperty({__proto__:null,fetch:ft,parseUrl:he},Symbol.toStringTag,{value:"Module"}));export{ft as e,Dt as o,_ as s};
